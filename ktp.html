<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KTP Repeater - X476dw Tools</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cropper.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    
    <style>
        /* CSS Khusus untuk mensimulasikan kertas A4 dan Printing */
        @page {
            size: A4;
            margin: 0;
        }
        @media print {
            body {
                background-color: white;
            }
            .no-print {
                display: none !important;
            }
            .page-container {
                display: block !important;
                margin: 0 !important;
            }
            .page {
                box-shadow: none !important;
                margin: 0 !important;
                border: none !important;
                width: 210mm !important;
                height: 296mm !important; 
                page-break-after: always; 
                page-break-inside: avoid;
            }
            .page:last-child {
                page-break-after: auto;
            }
        }

        .page-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .page {
            width: 210mm;
            min-height: 297mm;
            background: white;
            position: relative;
            box-shadow: 0 0 15px rgba(0,0,0,0.15);
            padding: 10mm;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 2mm;
            box-sizing: border-box;
            align-content: start;
        }

        .ktp-card {
            width: 85.6mm;
            height: 53.98mm;
            border: 1px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            background-color: #f3f4f6;
            margin: 0 auto;
        }

        .ktp-card img {
            width: 100%;
            height: 100%;
            object-fit: fill; /* Memaksa gambar memenuhi kotak hasil crop */
        }
        
        .grayscale-mode img {
            filter: grayscale(100%) contrast(120%);
        }
        
        .page-label {
            position: absolute;
            top: -30px;
            left: 0;
            width: 100%;
            text-align: center;
            font-weight: bold;
            color: #4b5563;
            text-transform: uppercase;
            font-size: 0.9rem;
            background-color: #e5e7eb;
            padding: 4px 0;
            border-radius: 4px;
        }

        .packet-btn.active {
            background-color: #fbbf24; 
            color: #1e3a8a; 
            border-color: #f59e0b;
            font-weight: 800;
            transform: scale(1.05);
        }

        /* Modal Cropping Styles */
        #cropModal {
            background-color: rgba(0, 0, 0, 0.85);
        }
        .cropper-container {
            max-height: 70vh;
        }
    </style>
</head>
<body class="bg-gray-200 min-h-screen font-sans">

    <!-- Control Panel -->
    <div class="no-print fixed top-0 left-0 w-full bg-blue-900 text-white shadow-lg z-50 p-2 md:p-4">
        <div class="max-w-6xl mx-auto flex flex-col gap-3">
            
            <!-- Header & Print Button -->
            <div class="flex justify-between items-center border-b border-blue-700 pb-2">
                <div>
                    <h1 class="text-lg md:text-xl font-bold">üõ†Ô∏è KTP Repeater Pro v5</h1>
                    <p class="text-xs text-blue-200">Fitur Baru: Potong (Crop) Gambar Presisi</p>
                </div>
                <button onclick="window.print()" class="bg-green-600 hover:bg-green-500 px-4 md:px-6 py-2 rounded shadow font-bold text-lg transition flex items-center gap-2">
                    üñ®Ô∏è PRINT
                </button>
            </div>

            <!-- Area Kontrol Utama -->
            <div class="flex flex-col md:flex-row gap-4 items-start md:items-center">
                
                <!-- 1. Pilihan Paket Harga -->
                <div class="flex bg-blue-800 p-2 rounded-lg gap-2">
                    <button onclick="setPacket(5)" id="btnPacket5" class="packet-btn flex-1 px-3 py-2 rounded border border-blue-500 hover:bg-blue-700 transition text-sm md:text-base text-center">
                        <div class="font-bold">Rp 1.000</div>
                        <div class="text-xs opacity-90">(5 Lembar)</div>
                    </button>
                    <button onclick="setPacket(10)" id="btnPacket10" class="packet-btn active flex-1 px-3 py-2 rounded border border-blue-500 hover:bg-blue-700 transition text-sm md:text-base text-center">
                        <div class="font-bold">Rp 2.000</div>
                        <div class="text-xs opacity-90">(10 Lembar)</div>
                    </button>
                </div>

                <!-- 2. Tombol Upload -->
                <div class="flex-1 flex gap-2 w-full">
                    <label class="cursor-pointer bg-blue-600 hover:bg-blue-500 px-3 py-2 rounded shadow transition flex-1 text-center border border-blue-400 flex flex-col justify-center">
                        <span class="font-bold text-sm">‚úÇÔ∏è Upload & Potong Depan</span>
                        <input type="file" id="imageInputFront" accept="image/*" class="hidden" onchange="initCrop(event, 'front')">
                    </label>

                    <label class="cursor-pointer bg-blue-600 hover:bg-blue-500 px-3 py-2 rounded shadow transition flex-1 text-center border border-blue-400 flex flex-col justify-center">
                        <span class="font-bold text-sm">‚úÇÔ∏è Upload & Potong Belakang</span>
                        <input type="file" id="imageInputBack" accept="image/*" class="hidden" onchange="initCrop(event, 'back')">
                    </label>
                </div>

                <!-- 3. Toggle Hitam Putih -->
                <button onclick="toggleGrayscale()" id="btnGrayscale" class="bg-gray-600 hover:bg-gray-500 px-3 py-2 rounded shadow transition flex items-center gap-2 h-full">
                    <span class="text-sm font-bold">BW:</span> 
                    <span id="statusGrayscale" class="font-bold bg-gray-800 px-2 rounded text-xs py-1">OFF</span>
                </button>
            </div>
        </div>
    </div>

    <div class="h-48 md:h-56 no-print"></div>

    <!-- Container Utama -->
    <div id="pagesContainer" class="page-container">
        <div class="page flex items-center justify-center text-gray-400">
            <div class="text-center">
                <p class="text-xl mb-2">Belum ada foto</p>
                <p class="text-sm">Klik Tombol "Upload & Potong" di menu atas</p>
            </div>
        </div>
    </div>

    <!-- Modal Cropping -->
    <div id="cropModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-blue-900 text-white p-3 flex justify-between items-center">
                <h3 class="font-bold text-lg">‚úÇÔ∏è Potong Gambar KTP</h3>
                <button onclick="closeModal()" class="text-gray-300 hover:text-white">&times;</button>
            </div>
            
            <div class="p-4 flex-1 overflow-auto bg-gray-100 flex items-center justify-center">
                <div class="max-w-full">
                    <img id="imageToCrop" src="" alt="Crop Preview" class="max-w-full block">
                </div>
            </div>

            <div class="p-4 bg-gray-50 border-t flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold">Batal</button>
                <button onclick="applyCrop()" class="px-6 py-2 rounded bg-green-600 hover:bg-green-700 text-white font-bold shadow-lg transform hover:scale-105 transition">‚úÖ Potong & Pakai</button>
            </div>
        </div>
    </div>

    <!-- Cropper JS Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <script>
        let frontSrc = null;
        let backSrc = null;
        let isGrayscale = false;
        let copiesPerPage = 10;
        
        // Variabel untuk Cropper
        let cropper = null;
        let currentCropType = null; // 'front' or 'back'

        function setPacket(count) {
            copiesPerPage = count;
            document.getElementById('btnPacket5').classList.remove('active');
            document.getElementById('btnPacket10').classList.remove('active');
            
            if (count === 5) {
                document.getElementById('btnPacket5').classList.add('active');
            } else {
                document.getElementById('btnPacket10').classList.add('active');
            }
            renderGrid();
        }

        // 1. Fungsi Inisialisasi Crop saat file dipilih
        function initCrop(event, type) {
            const input = event.target;
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentCropType = type;
                    openModal(e.target.result);
                }
                reader.readAsDataURL(input.files[0]);
            }
            // Reset input value agar bisa pilih file yang sama jika dicancel
            input.value = '';
        }

        // 2. Buka Modal dan Pasang CropperJS
        function openModal(imageSrc) {
            const modal = document.getElementById('cropModal');
            const imageElement = document.getElementById('imageToCrop');
            
            // Set sumber gambar
            imageElement.src = imageSrc;
            
            // Tampilkan Modal
            modal.classList.remove('hidden');

            // Hapus cropper lama jika ada
            if (cropper) {
                cropper.destroy();
            }

            // Inisialisasi Cropper Baru
            // Rasio KTP ISO/IEC 7810 ID-1: 85.60 √ó 53.98 mm
            cropper = new Cropper(imageElement, {
                aspectRatio: 85.6 / 53.98, 
                viewMode: 1, // Membatasi crop box agar tidak keluar dari gambar
                autoCropArea: 0.8,
                movable: true,
                zoomable: true,
                rotatable: true,
                scalable: true
            });
        }

        // 3. Terapkan Hasil Crop
        function applyCrop() {
            if (!cropper) return;

            // Ambil hasil crop sebagai Data URL (gambar base64)
            const canvas = cropper.getCroppedCanvas({
                width: 1011, // Resolusi tinggi (sekitar 300 DPI untuk 8.5cm)
                height: 638,
                imageSmoothingQuality: 'high'
            });

            const croppedImage = canvas.toDataURL('image/jpeg');

            // Simpan ke variabel global sesuai tipe
            if (currentCropType === 'front') {
                frontSrc = croppedImage;
            } else {
                backSrc = croppedImage;
            }

            closeModal();
            renderGrid();
        }

        function closeModal() {
            const modal = document.getElementById('cropModal');
            modal.classList.add('hidden');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        }

        // Fungsi Render Grid (Sama seperti sebelumnya)
        function createPage(imageSrc, labelText) {
            const pageDiv = document.createElement('div');
            pageDiv.className = 'page';
            
            const labelDiv = document.createElement('div');
            labelDiv.className = 'page-label no-print';
            labelDiv.innerText = `HALAMAN ${labelText} (ISI ${copiesPerPage} KARTU)`;
            pageDiv.appendChild(labelDiv);

            for (let i = 0; i < copiesPerPage; i++) {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'ktp-card';
                if (isGrayscale) cardDiv.classList.add('grayscale-mode');

                const img = document.createElement('img');
                img.src = imageSrc;
                // Karena sudah dicrop sesuai rasio, border bisa simple
                cardDiv.style.border = "1px solid #e5e7eb"; 
                cardDiv.appendChild(img);
                pageDiv.appendChild(cardDiv);
            }
            return pageDiv;
        }

        function renderGrid() {
            const container = document.getElementById('pagesContainer');
            container.innerHTML = '';

            if (!frontSrc && !backSrc) {
                container.innerHTML = `
                    <div class="page flex items-center justify-center text-gray-400">
                         <div class="text-center">
                            <p class="text-xl mb-2">Belum ada foto</p>
                            <p class="text-sm">Silakan upload dan crop foto di menu atas</p>
                        </div>
                    </div>`;
                return;
            }

            if (frontSrc) container.appendChild(createPage(frontSrc, "1: DEPAN"));
            if (backSrc) container.appendChild(createPage(backSrc, "2: BELAKANG"));
        }

        function toggleGrayscale() {
            isGrayscale = !isGrayscale;
            const btn = document.getElementById('btnGrayscale');
            const status = document.getElementById('statusGrayscale');

            if (isGrayscale) {
                btn.classList.remove('bg-gray-600');
                btn.classList.add('bg-gray-800', 'ring-2', 'ring-white');
                status.innerText = "ON";
            } else {
                btn.classList.add('bg-gray-600');
                btn.classList.remove('bg-gray-800', 'ring-2', 'ring-white');
                status.innerText = "OFF";
            }
            renderGrid();
        }
    </script>
</body>
</html>
