<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Data NPWP Lokal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 80%;
            max-width: 400px;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg mb-8 p-6">
            <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">Sistem Manajemen Data NPWP (Lokal)</h1>
            <p class="text-gray-600 text-center">Data Anda tersimpan aman di browser komputer ini.</p>
        </div>

        <!-- Input Form -->
        <div class="bg-white rounded-lg shadow-lg mb-8 p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-6">Input Data NPWP</h2>
            <form id="npwpForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">No</label>
                    <input type="number" id="no" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama</label>
                    <input type="text" id="nama" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password Email</label>
                    <input type="text" id="pasEmail" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">NIK</label>
                    <input type="text" id="nik" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">KK</label>
                    <input type="text" id="kk" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password NPWP</label>
                    <input type="text" id="pasNPWP" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password NPWP Terbaru</label>
                    <input type="text" id="pasNPWPTerbaru" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
            </form>
        </div>

        <!-- Control Buttons -->
        <div class="bg-white rounded-lg shadow-lg mb-8 p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Kontrol Data</h3>
            
            <div class="mb-6">
                <h4 class="text-md font-medium text-gray-700 mb-3">Navigasi Record</h4>
                <div class="flex flex-wrap gap-2">
                    <button id="firstRecord" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition-colors">‚èÆÔ∏è First</button>
                    <button id="prevRecord" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition-colors">‚è™ Previous</button>
                    <button id="nextRecord" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition-colors">‚è© Next</button>
                    <button id="lastRecord" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition-colors">‚è≠Ô∏è Last</button>
                </div>
            </div>

            <div class="mb-6">
                <h4 class="text-md font-medium text-gray-700 mb-3">Kontrol Data</h4>
                <div class="flex flex-wrap gap-2">
                    <button id="addNewRecord" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition-colors">‚ûï Tambah Data</button>
                    <button id="undoRecord" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md transition-colors">‚Ü∂ Undo</button>
                    <button id="saveRecord" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md transition-colors">üíæ Simpan Baru</button>
                    <button id="refreshData" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md transition-colors">üîÑ Muat Ulang</button>
                    <button id="emailMissing" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md transition-colors">üìß Email Belum Input</button>
                    </div>
            </div>

            <div class="mb-6">
                <h4 class="text-md font-medium text-gray-700 mb-3">Impor / Ekspor Excel</h4>
                <div class="flex flex-wrap gap-2">
                    <label for="importExcel" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-md transition-colors cursor-pointer">üì• Impor Excel</label>
                    <input type="file" id="importExcel" accept=".csv" class="hidden">
                    <button id="exportExcel" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-md transition-colors">üì§ Ekspor Excel</button>
                </div>
            </div>
        </div>

        <!-- Search -->
        <div class="bg-white rounded-lg shadow-lg mb-8 p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Pencarian Data</h3>
            <div class="flex gap-4">
                <input type="text" id="searchName" placeholder="Cari berdasarkan nama..." class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="searchBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md transition-colors">üîç Cari</button>
                <button id="clearSearch" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md transition-colors">‚úñÔ∏è Hapus</button>
            </div>
        </div>

        <!-- Email Input Form (Hidden by default) -->
        <div id="emailInputSection" class="bg-white rounded-lg shadow-lg mb-8 p-6 hidden">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-gray-800">Input Email untuk Data yang Belum Lengkap</h3>
                <button id="closeEmailForm" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition-colors">‚úñÔ∏è Tutup</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div><label class="block text-sm font-medium text-gray-700 mb-2">No</label><input type="number" id="emailFormNo" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100" readonly></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Email</label><input type="email" id="emailFormEmail" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Password Email</label><input type="text" id="emailFormPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required></div>
            </div>

            <div class="mb-6"><label class="flex items-center"><input type="checkbox" id="emailCompleted" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"><span class="text-sm text-gray-700">Email sudah diinput dengan benar</span></label></div>

            <div class="mb-6">
                <h4 class="text-md font-medium text-gray-700 mb-3">Kontrol Email Form</h4>
                <div class="mb-4">
                    <h5 class="text-sm font-medium text-gray-600 mb-2">Navigasi Record</h5>
                    <div class="flex flex-wrap gap-2">
                        <button id="emailFirstRecord" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-md transition-colors text-sm">‚èÆÔ∏è First</button>
                        <button id="emailPrevRecord" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-md transition-colors text-sm">‚è™ Previous</button>
                        <button id="emailNextRecord" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-md transition-colors text-sm">‚è© Next</button>
                        <button id="emailLastRecord" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-md transition-colors text-sm">‚è≠Ô∏è Last</button>
                    </div>
                </div>
                <div>
                    <h5 class="text-sm font-medium text-gray-600 mb-2">Kontrol Data</h5>
                    <div class="flex flex-wrap gap-2">
                        <button id="emailUndoRecord" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded-md transition-colors text-sm">‚Ü∂ Undo</button>
                        <button id="emailSaveRecord" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-md transition-colors text-sm">üíæ Perbarui Email</button>
                        <button id="emailRefreshData" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-md transition-colors text-sm">üîÑ Muat Ulang</button>
                    </div>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full table-auto">
                    <thead><tr class="bg-gray-50"><th class="px-4 py-3 text-left text-sm font-medium text-gray-700">No</th><th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nama</th><th class="px-4 py-3 text-left text-sm font-medium text-gray-700">NIK</th><th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Email</th><th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th><th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Aksi</th></tr></thead>
                    <tbody id="emailDataTable"></tbody>
                </table>
            </div>
            <div id="noEmailData" class="text-center py-8 text-gray-500 hidden">Semua data sudah memiliki email</div>
            <div class="mt-4 bg-gray-50 rounded-lg p-4"><div class="flex justify-between items-center text-sm text-gray-600"><span id="emailRecordCount">Total: 0 record tanpa email</span><span id="emailCurrentRecord">Record: 0 / 0</span></div></div>
        </div>

        <!-- Database Display -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Database NPWP</h3>
            <div class="overflow-x-auto">
                <table class="w-full table-auto">
                    <thead><tr class="bg-gray-50"><th class="px-4 py-3 text-left text-sm font-medium text-gray-700">No</th><th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nama</th><th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Email</th><th class="px-4 py-3 text-left text-sm font-medium text-gray-700">NIK</th><th class="px-4 py-3 text-left text-sm font-medium text-gray-700">KK</th><th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status Email</th><th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Aksi</th></tr></thead>
                    <tbody id="dataTable"></tbody>
                </table>
            </div>
            <div id="noData" class="text-center py-8 text-gray-500 hidden">Tidak ada data yang ditemukan</div>
        </div>

        <!-- Status Bar -->
        <div class="mt-6 bg-white rounded-lg shadow-lg p-4"><div class="flex justify-between items-center text-sm text-gray-600"><span id="recordCount">Total: 0 record</span><span id="currentRecord">Record: 0 / 0</span></div></div>

        <!-- Custom Modals -->
        <div id="messageModal" class="modal"><div class="modal-content"><p id="modalMessage" class="text-gray-800 mb-4"></p><button onclick="document.getElementById('messageModal').style.display='none'" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition-colors">OK</button></div></div>
        <div id="confirmModal" class="modal"><div class="modal-content"><p id="confirmMessage" class="text-gray-800 mb-4"></p><div class="flex justify-center gap-4"><button id="confirmYes" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md transition-colors">Ya</button><button id="confirmNo" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition-colors">Batal</button></div></div></div>
    </div>

    <script>
	
        document.addEventListener('DOMContentLoaded', () => {
            const LOCAL_STORAGE_KEY = 'npwp_database_lokal';
            
            let npwpData = [];
            let currentIndex = 0;
            let filteredData = [];
            let originalData = {};
            let isEditing = false;
            let currentDocId = null;
            
            let emailCurrentIndex = 0;
            let emailFilteredData = [];
            let emailOriginalData = {};

            // --- UI Elements ---
            const inputs = {
                no: document.getElementById('no'),
                nama: document.getElementById('nama'),
                email: document.getElementById('email'),
                pasEmail: document.getElementById('pasEmail'),
                nik: document.getElementById('nik'),
                kk: document.getElementById('kk'),
                pasNPWP: document.getElementById('pasNPWP'),
                pasNPWPTerbaru: document.getElementById('pasNPWPTerbaru')
            };
            const emailFormInputs = {
                no: document.getElementById('emailFormNo'),
                email: document.getElementById('emailFormEmail'),
                password: document.getElementById('emailFormPassword'),
                completed: document.getElementById('emailCompleted')
            };
            const saveRecordBtn = document.getElementById('saveRecord');

            // --- Custom Modal Functions ---
            const showMessageBox = (message) => {
                document.getElementById('modalMessage').textContent = message;
                document.getElementById('messageModal').style.display = 'block';
            };

            const showConfirmation = (message, onConfirm, onCancel) => {
                document.getElementById('confirmMessage').textContent = message;
                document.getElementById('confirmModal').style.display = 'block';
                const confirmYesBtn = document.getElementById('confirmYes');
                const confirmNoBtn = document.getElementById('confirmNo');
                const handleYes = () => { onConfirm(); cleanup(); };
                const handleNo = () => { onCancel(); cleanup(); };
                const cleanup = () => {
                    document.getElementById('confirmModal').style.display = 'none';
                    confirmYesBtn.removeEventListener('click', handleYes);
                    confirmNoBtn.removeEventListener('click', handleNo);
                };
                confirmYesBtn.addEventListener('click', handleYes);
                confirmNoBtn.addEventListener('click', handleNo);
            };

            // --- Local Storage Functions ---
            const loadDataFromLocal = () => {
                const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                npwpData = savedData ? JSON.parse(savedData) : [];
                filteredData = [...npwpData];
                updateDisplay();
                loadRecord(currentIndex);
            };

            const saveDataToLocal = () => {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(npwpData));
            };

            // --- Data Display & Navigation ---
            function loadRecord(index) {
                if (index >= 0 && index < filteredData.length) {
                    const record = filteredData[index];
                    originalData = { ...record };
                    currentDocId = record.id;
                    inputs.no.value = index + 1;
                    inputs.nama.value = record.nama || '';
                    inputs.email.value = record.email || '';
                    inputs.pasEmail.value = record.pasEmail || '';
                    inputs.nik.value = record.nik || '';
                    inputs.kk.value = record.kk || '';
                    inputs.pasNPWP.value = record.pasNPWP || '';
                    inputs.pasNPWPTerbaru.value = record.pasNPWPTerbaru || '';
                    updateStatusBar();
                } else if (filteredData.length === 0) {
                    clearForm();
                    updateStatusBar();
                }
            }

            function clearForm() {
                Object.values(inputs).forEach(input => input.id !== 'no' ? input.value = '' : null);
                inputs.no.value = npwpData.length + 1;
                originalData = {};
                isEditing = false;
                currentDocId = null;
                saveRecordBtn.textContent = 'üíæ Simpan Baru';
            }

            function updateDisplay() {
                const tableBody = document.getElementById('dataTable');
                const noDataDiv = document.getElementById('noData');
                if (filteredData.length === 0) {
                    tableBody.innerHTML = '';
                    noDataDiv.classList.remove('hidden');
                } else {
                    noDataDiv.classList.add('hidden');
                    tableBody.innerHTML = filteredData.map((record, index) => `
                        <tr class="border-b hover:bg-gray-50 cursor-pointer ${index === currentIndex ? 'bg-blue-50' : ''}" onclick="window.selectRecord(${index})">
                            <td class="px-4 py-3 text-sm">${index + 1}</td>
                            <td class="px-4 py-3 text-sm font-medium">${record.nama || '-'}</td>
                            <td class="px-4 py-3 text-sm">${record.email || '-'}</td>
                            <td class="px-4 py-3 text-sm">${record.nik || '-'}</td>
                            <td class="px-4 py-3 text-sm">${record.kk || '-'}</td>
                            <td class="px-4 py-3 text-sm"><span class="px-2 py-1 rounded-full text-xs ${record.hasEmail ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${record.hasEmail ? 'Ada Email' : 'Belum Input'}</span></td>
                            <td class="px-4 py-3 text-sm">
                                <button onclick="event.stopPropagation(); window.editRecord(${index})" class="text-blue-600 hover:text-blue-800 mr-2">Edit</button>
                                <button onclick="event.stopPropagation(); window.deleteRecord('${record.id}')" class="text-red-600 hover:text-red-800">Hapus</button>
                            </td>
                        </tr>`).join('');
                }
                updateStatusBar();
            }

            function updateStatusBar() {
                document.getElementById('recordCount').textContent = `Total: ${npwpData.length} record`;
                document.getElementById('currentRecord').textContent = `Record: ${filteredData.length > 0 ? currentIndex + 1 : 0} / ${filteredData.length}`;
            }

            // --- Event Listeners ---
            document.getElementById('firstRecord').addEventListener('click', () => { if (filteredData.length > 0) { currentIndex = 0; loadRecord(currentIndex); } });
            document.getElementById('prevRecord').addEventListener('click', () => { if (currentIndex > 0) { currentIndex--; loadRecord(currentIndex); } });
            document.getElementById('nextRecord').addEventListener('click', () => { if (currentIndex < filteredData.length - 1) { currentIndex++; loadRecord(currentIndex); } });
            document.getElementById('lastRecord').addEventListener('click', () => { if (filteredData.length > 0) { currentIndex = filteredData.length - 1; loadRecord(currentIndex); } });

            document.getElementById('addNewRecord').addEventListener('click', clearForm);

            document.getElementById('undoRecord').addEventListener('click', () => {
                if (originalData && Object.keys(originalData).length > 0) {
                    Object.keys(inputs).forEach(key => { if (key !== 'no') { inputs[key].value = originalData[key] || ''; } });
                    showMessageBox('Data berhasil dikembalikan ke kondisi semula!');
                }
            });

            saveRecordBtn.addEventListener('click', () => {
                if (!validateForm()) return;

                const recordData = {
                    nama: inputs.nama.value, email: inputs.email.value, pasEmail: inputs.pasEmail.value,
                    nik: inputs.nik.value, kk: inputs.kk.value, pasNPWP: inputs.pasNPWP.value,
                    pasNPWPTerbaru: inputs.pasNPWPTerbaru.value, hasEmail: inputs.email.value.trim() !== ''
                };
                
                if (isEditing && currentDocId) {
                    const index = npwpData.findIndex(d => d.id === currentDocId);
                    if (index > -1) {
                        npwpData[index] = { ...npwpData[index], ...recordData };
                        showMessageBox('Data berhasil diperbarui!');
                    }
                } else {
                    recordData.id = crypto.randomUUID(); // Generate unique ID
                    npwpData.push(recordData);
                    showMessageBox('Data berhasil disimpan!');
                }
                
                saveDataToLocal();
                filteredData = [...npwpData];
                if (!isEditing) currentIndex = npwpData.length - 1;
                updateDisplay();
                clearForm();
                loadRecord(currentIndex);
            });

            document.getElementById('refreshData').addEventListener('click', loadDataFromLocal);

            document.getElementById('emailMissing').addEventListener('click', () => {
                // Mengarahkan ke URL eksternal sesuai permintaan
                window.open('https://musadad87.github.io/kalkulator-undangan/email.html', '_blank');
            });

            document.getElementById('searchBtn').addEventListener('click', () => {
                const searchTerm = document.getElementById('searchName').value.toLowerCase();
                filteredData = searchTerm.trim() === '' ? [...npwpData] : npwpData.filter(r => r.nama.toLowerCase().includes(searchTerm));
                currentIndex = 0;
                updateDisplay();
                if (filteredData.length > 0) loadRecord(0);
            });

            document.getElementById('clearSearch').addEventListener('click', () => {
                document.getElementById('searchName').value = '';
                filteredData = [...npwpData];
                currentIndex = 0;
                updateDisplay();
                if (filteredData.length > 0) loadRecord(0);
            });

            window.selectRecord = (index) => { currentIndex = index; loadRecord(index); updateDisplay(); };
            window.editRecord = (index) => {
                currentIndex = index; loadRecord(index); isEditing = true;
                saveRecordBtn.textContent = 'üíæ Perbarui Data';
                showMessageBox("Anda dalam mode edit. Tekan 'Perbarui Data' untuk menyimpan perubahan.");
                window.scrollTo(0, 0);
            };

            window.deleteRecord = (docId) => {
                showConfirmation("Apakah Anda yakin ingin menghapus record ini?", () => {
                    npwpData = npwpData.filter(record => record.id !== docId);
                    saveDataToLocal();
                    if (currentIndex >= npwpData.length) currentIndex = Math.max(0, npwpData.length - 1);
                    loadDataFromLocal();
                    showMessageBox('Record berhasil dihapus!');
                }, () => console.log("Deletion cancelled."));
            };

            function validateForm() {
                const requiredFields = ['nama', 'nik', 'kk'];
                for (let field of requiredFields) {
                    if (!inputs[field].value.trim()) {
                        showMessageBox(`Field ${field.toUpperCase()} harus diisi!`);
                        inputs[field].focus();
                        return false;
                    }
                }
                return true;
            }

            // --- Excel Import/Export Logic ---
            document.getElementById('exportExcel').addEventListener('click', () => {
                if (npwpData.length === 0) return showMessageBox('Tidak ada data untuk diekspor.');
                const header = ["Nama", "Email", "Password Email", "NIK", "KK", "Password NPWP", "Password NPWP Terbaru", "Status Email"];
                const rows = npwpData.map(r => [r.nama, r.email, r.pasEmail, r.nik, r.kk, r.pasNPWP, r.pasNPWPTerbaru, r.hasEmail ? 'Ada' : 'Belum Input'].map(String));
                let csvContent = header.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "data_npwp_lokal.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessageBox('Data berhasil diekspor!');
            });

            document.getElementById('importExcel').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const rows = e.target.result.split('\n').map(row => row.split(','));
                    if (rows.length <= 1) return showMessageBox("File kosong atau tidak valid.");
                    const dataToImport = rows.slice(1);
                    let importCount = 0;
                    dataToImport.forEach(row => {
                        if (row.length > 1 && row[0].trim() !== '') {
                            npwpData.push({
                                id: crypto.randomUUID(), nama: (row[0]||'').trim(), email: (row[1]||'').trim(),
                                pasEmail: (row[2]||'').trim(), nik: (row[3]||'').trim(), kk: (row[4]||'').trim(),
                                pasNPWP: (row[5]||'').trim(), pasNPWPTerbaru: (row[6]||'').trim(),
                                hasEmail: (row[1]||'').trim() !== ''
                            });
                            importCount++;
                        }
                    });
                    saveDataToLocal();
                    loadDataFromLocal();
                    showMessageBox(`Impor selesai: ${importCount} data berhasil ditambahkan.`);
                    event.target.value = '';
                };
                reader.readAsText(file);
            });

            // --- Email Form Logic ---
            document.getElementById('closeEmailForm').addEventListener('click', () => document.getElementById('emailInputSection').classList.add('hidden'));
            document.getElementById('emailFirstRecord').addEventListener('click', () => { if (emailFilteredData.length > 0) { emailCurrentIndex = 0; loadEmailRecord(emailCurrentIndex); } });
            document.getElementById('emailPrevRecord').addEventListener('click', () => { if (emailCurrentIndex > 0) { emailCurrentIndex--; loadEmailRecord(emailCurrentIndex); } });
            document.getElementById('emailNextRecord').addEventListener('click', () => { if (emailCurrentIndex < emailFilteredData.length - 1) { emailCurrentIndex++; loadEmailRecord(emailCurrentIndex); } });
            document.getElementById('emailLastRecord').addEventListener('click', () => { if (emailFilteredData.length > 0) { emailCurrentIndex = emailFilteredData.length - 1; loadEmailRecord(emailCurrentIndex); } });
            document.getElementById('emailUndoRecord').addEventListener('click', () => {
                if (emailOriginalData && Object.keys(emailOriginalData).length > 0) {
                    emailFormInputs.email.value = emailOriginalData.email || '';
                    emailFormInputs.password.value = emailOriginalData.pasEmail || '';
                    emailFormInputs.completed.checked = false;
                    showMessageBox('Data email berhasil dikembalikan!');
                }
            });

            document.getElementById('emailSaveRecord').addEventListener('click', () => {
                const email = emailFormInputs.email.value.trim();
                const password = emailFormInputs.password.value.trim();
                if (!email || !password) return showMessageBox('Email dan Password harus diisi!');
                if (!emailFormInputs.completed.checked) return showMessageBox('Harap centang checkbox untuk konfirmasi!');
                
                const currentRecord = emailFilteredData[emailCurrentIndex];
                const mainDbIndex = npwpData.findIndex(d => d.id === currentRecord.id);
                if (mainDbIndex > -1) {
                    npwpData[mainDbIndex].email = email;
                    npwpData[mainDbIndex].pasEmail = password;
                    npwpData[mainDbIndex].hasEmail = true;
                    saveDataToLocal();
                    showMessageBox('Email berhasil diupdate!');
                    
                    emailFilteredData.splice(emailCurrentIndex, 1);
                    if (emailCurrentIndex >= emailFilteredData.length) emailCurrentIndex = Math.max(0, emailFilteredData.length - 1);
                    updateEmailDisplay();
                    
                    if (emailFilteredData.length === 0) {
                        showMessageBox('Semua email sudah diinput! Form akan ditutup.');
                        document.getElementById('emailInputSection').classList.add('hidden');
                        loadDataFromLocal(); // Refresh main table
                    } else {
                        loadEmailRecord(emailCurrentIndex);
                    }
                }
            });

            document.getElementById('emailRefreshData').addEventListener('click', () => {
                emailFilteredData = npwpData.filter(r => !r.hasEmail || r.email.trim() === '');
                emailCurrentIndex = 0;
                updateEmailDisplay();
                if (emailFilteredData.length > 0) loadEmailRecord(0);
            });
            
            function loadEmailRecord(index) {
                if (index >= 0 && index < emailFilteredData.length) {
                    const record = emailFilteredData[index];
                    emailOriginalData = { ...record };
                    emailFormInputs.no.value = index + 1;
                    emailFormInputs.email.value = record.email || '';
                    emailFormInputs.password.value = record.pasEmail || '';
                    emailFormInputs.completed.checked = false;
                    updateEmailStatusBar();
                }
            }

            function updateEmailDisplay() {
                const tableBody = document.getElementById('emailDataTable');
                const noDataDiv = document.getElementById('noEmailData');
                if (emailFilteredData.length === 0) {
                    tableBody.innerHTML = ''; noDataDiv.classList.remove('hidden');
                } else {
                    noDataDiv.classList.add('hidden');
                    tableBody.innerHTML = emailFilteredData.map((record, index) => `
                        <tr class="border-b hover:bg-gray-50 cursor-pointer ${index === emailCurrentIndex ? 'bg-blue-50' : ''}" onclick="window.selectEmailRecord(${index})">
                            <td class="px-4 py-3 text-sm">${index + 1}</td>
                            <td class="px-4 py-3 text-sm font-medium">${record.nama || '-'}</td>
                            <td class="px-4 py-3 text-sm">${record.nik || '-'}</td>
                            <td class="px-4 py-3 text-sm">${record.email || '-'}</td>
                            <td class="px-4 py-3 text-sm"><span class="px-2 py-1 rounded-full text-xs bg-red-100 text-red-800">Belum Input</span></td>
                            <td class="px-4 py-3 text-sm"><button onclick="event.stopPropagation(); window.editEmailRecord(${index})" class="text-blue-600 hover:text-blue-800">Input Email</button></td>
                        </tr>`).join('');
                }
                updateEmailStatusBar();
            }

            window.selectEmailRecord = (index) => { emailCurrentIndex = index; loadEmailRecord(index); updateEmailDisplay(); };
            window.editEmailRecord = (index) => { emailCurrentIndex = index; loadEmailRecord(index); window.scrollTo(0, document.getElementById('emailInputSection').offsetTop); };
            function updateEmailStatusBar() {
                document.getElementById('emailRecordCount').textContent = `Total: ${emailFilteredData.length} record tanpa email`;
                document.getElementById('emailCurrentRecord').textContent = `Record: ${emailFilteredData.length > 0 ? emailCurrentIndex + 1 : 0} / ${emailFilteredData.length}`;
            }
            
            // Initial Load
            loadDataFromLocal();
			        });
    </script>
</body>
</html>



