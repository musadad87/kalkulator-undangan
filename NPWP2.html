<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Data NPWP (Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        /* Loading overlay */
        #loadingOverlay {
            display: flex;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255,255,255,0.9);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.3s;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-100 to-blue-50 min-h-screen text-gray-800">
    
    <!-- Loading Screen -->
    <div id="loadingOverlay">
        <div class="spinner mb-4"></div>
        <p class="text-gray-600 font-semibold animate-pulse" id="loadingText">Menghubungkan ke Database Firebase...</p>
        <button id="forceConfigBtn" class="hidden mt-4 text-blue-500 text-sm hover:underline">Gagal terhubung? Klik untuk atur konfigurasi</button>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 mb-6 p-6 relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4">
                <button id="openSettings" class="text-gray-400 hover:text-gray-700 transition-colors" title="Pengaturan Database">
                    <i class="fas fa-cog fa-lg"></i>
                </button>
            </div>
            <div class="flex flex-col items-center justify-center">
                <div class="bg-blue-100 p-3 rounded-full mb-3">
                    <i class="fas fa-cloud-database text-blue-600 text-2xl"></i>
                </div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800 text-center mb-1">Sistem Manajemen Data NPWP</h1>
                <p class="text-gray-500 text-center text-sm">Cloud Database Management</p>
                <div class="mt-3 flex items-center gap-2 px-3 py-1 bg-gray-50 rounded-full border border-gray-200">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse" id="connectionStatusIndicator"></div>
                    <p class="text-xs text-gray-500 font-mono" id="projectIdDisplay">Connecting...</p>
                </div>
            </div>
        </div>

        <!-- Input Form -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 mb-6 p-6">
            <div class="flex items-center gap-2 mb-6 pb-2 border-b border-gray-100">
                <i class="fas fa-pen-to-square text-blue-500"></i>
                <h2 class="text-lg font-semibold text-gray-800">Input Data NPWP</h2>
            </div>
            <form id="npwpForm" class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">No Record</label>
                    <input type="number" id="no" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 text-gray-500 font-mono" readonly>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Nama Lengkap</label>
                    <input type="text" id="nama" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" required placeholder="Masukkan nama...">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Email</label>
                    <input type="email" id="email" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="contoh@email.com">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Password Email</label>
                    <div class="relative">
                        <input type="text" id="pasEmail" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">NIK</label>
                    <input type="text" id="nik" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all font-mono" required placeholder="16 digit NIK">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">KK</label>
                    <input type="text" id="kk" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all font-mono" required placeholder="16 digit KK">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Password NPWP</label>
                    <input type="text" id="pasNPWP" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Password NPWP Terbaru</label>
                    <input type="text" id="pasNPWPTerbaru" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all bg-yellow-50 border-yellow-200">
                </div>
            </form>
        </div>

        <!-- Control Panel -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Navigation -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                <h4 class="text-sm font-semibold text-gray-600 mb-4 flex items-center gap-2"><i class="fas fa-arrows-left-right text-gray-400"></i> Navigasi</h4>
                <div class="flex justify-between gap-2">
                    <button id="firstRecord" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded-lg transition-colors text-sm"><i class="fas fa-angle-double-left"></i></button>
                    <button id="prevRecord" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded-lg transition-colors text-sm"><i class="fas fa-angle-left"></i></button>
                    <button id="nextRecord" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded-lg transition-colors text-sm"><i class="fas fa-angle-right"></i></button>
                    <button id="lastRecord" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded-lg transition-colors text-sm"><i class="fas fa-angle-double-right"></i></button>
                </div>
                <div class="mt-3 text-center">
                    <span id="currentRecord" class="text-xs font-mono text-gray-500 bg-gray-50 px-3 py-1 rounded-full">Record: 0 / 0</span>
                </div>
            </div>

            <!-- Actions -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 lg:col-span-2">
                <h4 class="text-sm font-semibold text-gray-600 mb-4 flex items-center gap-2"><i class="fas fa-bolt text-yellow-500"></i> Aksi Data</h4>
                <div class="flex flex-wrap gap-3">
                    <button id="addNewRecord" class="bg-blue-50 hover:bg-blue-100 text-blue-600 px-4 py-2 rounded-lg transition-colors text-sm font-medium border border-blue-200">
                        <i class="fas fa-plus mr-1"></i> Baru
                    </button>
                    <button id="undoRecord" class="bg-gray-50 hover:bg-gray-100 text-gray-600 px-4 py-2 rounded-lg transition-colors text-sm font-medium border border-gray-200">
                        <i class="fas fa-undo mr-1"></i> Reset
                    </button>
                    <button id="saveRecord" class="flex-grow bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white px-6 py-2 rounded-lg transition-all shadow-md transform hover:-translate-y-0.5 text-sm font-bold">
                        <i class="fas fa-save mr-2"></i> SIMPAN DATA
                    </button>
                    <button id="emailMissing" class="bg-orange-50 hover:bg-orange-100 text-orange-600 px-4 py-2 rounded-lg transition-colors text-sm font-medium border border-orange-200" title="Cari data tanpa email">
                        <i class="fas fa-envelope-open-text mr-1"></i> Cek Email
                    </button>
                    
                    <!-- Tombol Tambahan Baru -->
                    <a href="https://musadad87.github.io/kalkulator-undangan/email.html" class="bg-purple-50 hover:bg-purple-100 text-purple-600 px-4 py-2 rounded-lg transition-colors text-sm font-medium border border-purple-200 flex items-center justify-center decoration-0">
                        <i class="fas fa-user-plus mr-2"></i> Email Belum Input
                    </a>
                    <a href="https://musadad87.github.io/kalkulator-undangan/" class="bg-gray-50 hover:bg-gray-100 text-gray-600 px-4 py-2 rounded-lg transition-colors text-sm font-medium border border-gray-200 flex items-center justify-center decoration-0">
                        <i class="fas fa-arrow-left mr-2"></i> Kembali
                    </a>
                </div>
            </div>
        </div>

        <!-- Search & Tools -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 mb-6 p-5">
            <div class="flex flex-col md:flex-row gap-4 justify-between items-center">
                <div class="w-full md:w-1/2 relative">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    <input type="text" id="searchName" placeholder="Cari berdasarkan nama..." class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex gap-2 w-full md:w-auto">
                    <label for="importExcel" class="flex-1 md:flex-none bg-emerald-50 hover:bg-emerald-100 text-emerald-600 px-4 py-2 rounded-lg transition-colors cursor-pointer text-sm font-medium border border-emerald-200 flex items-center justify-center gap-2">
                        <i class="fas fa-file-import"></i> Impor CSV
                    </label>
                    <input type="file" id="importExcel" accept=".csv" class="hidden">
                    <button id="exportExcel" class="flex-1 md:flex-none bg-emerald-50 hover:bg-emerald-100 text-emerald-600 px-4 py-2 rounded-lg transition-colors text-sm font-medium border border-emerald-200 flex items-center justify-center gap-2">
                        <i class="fas fa-file-export"></i> Ekspor CSV
                    </button>
                </div>
            </div>
        </div>

        <!-- Email Input Mode (Conditional) -->
        <div id="emailInputSection" class="bg-orange-50 rounded-xl shadow-inner border border-orange-200 mb-6 p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-md font-bold text-orange-800 flex items-center gap-2">
                    <i class="fas fa-exclamation-circle"></i> Melengkapi Data Email
                </h3>
                <button id="closeEmailForm" class="text-orange-400 hover:text-orange-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="bg-white p-4 rounded-lg shadow-sm mb-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">Nama Pemilik</label>
                        <input type="text" id="emailFormName" class="w-full px-3 py-2 bg-gray-100 rounded border border-gray-200 text-gray-600" readonly>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">Email Baru</label>
                        <input type="email" id="emailFormEmail" class="w-full px-3 py-2 border border-orange-300 rounded focus:ring-2 focus:ring-orange-500 focus:outline-none" placeholder="Masukkan email...">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">Password Email</label>
                        <input type="text" id="emailFormPassword" class="w-full px-3 py-2 border border-orange-300 rounded focus:ring-2 focus:ring-orange-500 focus:outline-none" placeholder="Password...">
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <button id="emailPrevRecord" class="p-2 bg-orange-100 text-orange-700 rounded hover:bg-orange-200"><i class="fas fa-chevron-left"></i></button>
                    <span id="emailStatusText" class="text-xs font-mono text-orange-700">0/0</span>
                    <button id="emailNextRecord" class="p-2 bg-orange-100 text-orange-700 rounded hover:bg-orange-200"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="flex items-center gap-3">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="emailCompleted" class="mr-2 rounded text-orange-600 focus:ring-orange-500">
                        <span class="text-xs text-orange-800 font-medium">Data Valid</span>
                    </label>
                    <button id="emailSaveRecord" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm">
                        Simpan Perubahan
                    </button>
                </div>
            </div>
        </div>

        <!-- Database Table -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                <h3 class="text-sm font-semibold text-gray-700">Database Live View</h3>
                <span class="text-xs text-gray-400" id="totalCount">Total: 0</span>
            </div>
            <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-500 uppercase bg-gray-50 sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="px-6 py-3 font-medium">No</th>
                            <th class="px-6 py-3 font-medium">Nama</th>
                            <th class="px-6 py-3 font-medium">Email</th>
                            <th class="px-6 py-3 font-medium">NIK / KK</th>
                            <th class="px-6 py-3 font-medium text-center">Status</th>
                            <th class="px-6 py-3 font-medium text-right">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable" class="divide-y divide-gray-100">
                        <!-- Data rows will be inserted here -->
                    </tbody>
                </table>
            </div>
            <div id="noData" class="hidden p-8 text-center text-gray-400 bg-gray-50">
                <i class="fas fa-database text-4xl mb-2 opacity-50"></i>
                <p>Belum ada data tersedia</p>
            </div>
        </div>

        <!-- SETTINGS MODAL -->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h2 class="text-xl font-bold text-gray-800">⚙️ Konfigurasi Database</h2>
                    <span id="closeSettings" class="text-gray-400 hover:text-gray-600 cursor-pointer text-2xl">&times;</span>
                </div>
                
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                    <p class="text-sm text-blue-700">
                        Atur koneksi ke Firebase. Jika menggunakan Project Anda sendiri, masukkan ID di bawah ini.
                    </p>
                </div>

                <form id="configForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Project ID <span class="text-red-500">*</span></label>
                        <input type="text" id="confProjectId" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none" placeholder="contoh: my-project-id-123" required>
                        <p class="text-xs text-gray-500 mt-1">Dapat ditemukan di Project Settings.</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">API Key <span class="text-red-500">*</span></label>
                        <input type="text" id="confApiKey" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none font-mono text-xs" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">App ID <span class="text-red-500">*</span></label>
                        <input type="text" id="confAppId" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none font-mono text-xs" required>
                    </div>

                    <div class="pt-4 flex gap-3">
                        <button type="button" id="resetConfig" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50">Reset Default</button>
                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-medium">Simpan & Reload</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Alert Modal -->
        <div id="messageModal" class="modal">
            <div class="modal-content max-w-sm text-center">
                <div class="mb-4 text-4xl text-blue-500"><i class="fas fa-info-circle"></i></div>
                <p id="modalMessage" class="text-gray-800 mb-6 font-medium"></p>
                <button onclick="document.getElementById('messageModal').style.display='none'" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-full transition-colors w-full">OK</button>
            </div>
        </div>
        
        <!-- Confirm Modal -->
        <div id="confirmModal" class="modal">
            <div class="modal-content max-w-sm text-center">
                <div class="mb-4 text-4xl text-yellow-500"><i class="fas fa-question-circle"></i></div>
                <p id="confirmMessage" class="text-gray-800 mb-6 font-medium"></p>
                <div class="flex justify-center gap-3">
                    <button id="confirmNo" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-2 rounded-lg transition-colors flex-1">Batal</button>
                    <button id="confirmYes" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition-colors flex-1">Ya, Lanjutkan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // APP ID from Environment (Critical for Permissions)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // DEFAULT CONFIG (Fallback)
        const DEFAULT_CONFIG = {
            apiKey: "AIzaSyA46mqToU4xqGVo65BTwg2yWBOvvmNnZ6Q", 
            authDomain: "crested-primacy-482717-k6.firebaseapp.com",
            projectId: "crested-primacy-482717-k6",
            storageBucket: "crested-primacy-482717-k6.firebasestorage.app",
            messagingSenderId: "634237688418",
            appId: "1:634237688418:web:a4668eb46b4499b9650f3b",
            measurementId: "G-313RNYCKEQ"
        };

        // --- 1. Config Management Logic ---
        
        function getFirebaseConfig() {
            const saved = localStorage.getItem('npwp_firebase_config');
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch(e) {
                    console.error("Config corrupt, using default");
                    return DEFAULT_CONFIG;
                }
            }
            return DEFAULT_CONFIG;
        }

        const firebaseConfig = getFirebaseConfig();
        
        // Update UI with current Config Project ID
        document.getElementById('projectIdDisplay').innerText = firebaseConfig.projectId;
        
        // --- 2. Initialize Firebase ---
        
        let app, auth, db, analytics;
        let isConnected = false;

        try {
            app = initializeApp(firebaseConfig);
            analytics = getAnalytics(app);
            auth = getAuth(app);
            db = getFirestore(app);
            isConnected = true;
        } catch (error) {
            console.error("Firebase Init Error:", error);
            document.getElementById('loadingText').innerText = "Gagal Inisialisasi Firebase. Cek Konfigurasi.";
            document.getElementById('loadingText').classList.add('text-red-500');
            document.getElementById('forceConfigBtn').classList.remove('hidden');
        }

        // Helper functions for Paths (STRICT MODE Fix with Custom Fallback)
        const getCollectionRef = () => {
             // LOGIKA PINTAR:
             // 1. Jika User menggunakan Project ID DEFAULT (Bawaan Sistem) -> Gunakan path /artifacts/... (Wajib untuk sistem ini)
             // 2. Jika User menggunakan Project ID SENDIRI (Custom) -> Gunakan path /npwp_data (Standar Firebase biasa)
             
             if (firebaseConfig.projectId === DEFAULT_CONFIG.projectId) {
                return collection(db, 'artifacts', appId, 'public', 'data', 'npwp_data');
             } else {
                return collection(db, 'npwp_data');
             }
        };

        const getDocRef = (id) => {
             if (firebaseConfig.projectId === DEFAULT_CONFIG.projectId) {
                return doc(db, 'artifacts', appId, 'public', 'data', 'npwp_data', id);
             } else {
                return doc(db, 'npwp_data', id);
             }
        };

        // State & Refs
        let npwpData = [];
        let filteredData = [];
        let currentIndex = 0;
        let isEditing = false;
        let currentDocId = null;
        let emailMissingData = [];
        
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        
        // Input Refs
        const inputs = {
            no: document.getElementById('no'),
            nama: document.getElementById('nama'),
            email: document.getElementById('email'),
            pasEmail: document.getElementById('pasEmail'),
            nik: document.getElementById('nik'),
            kk: document.getElementById('kk'),
            pasNPWP: document.getElementById('pasNPWP'),
            pasNPWPTerbaru: document.getElementById('pasNPWPTerbaru')
        };

        // --- 3. Authentication & Data Listeners ---

        async function initApp() {
            if(!isConnected) return;
            
            try {
                // Set timeout for connection
                const timeout = setTimeout(() => {
                    if(loadingOverlay.style.display !== 'none') {
                        loadingText.innerText = "Koneksi lambat atau Project ID salah...";
                        document.getElementById('forceConfigBtn').classList.remove('hidden');
                    }
                }, 7000);

                // FIXED: Try custom token, but catch mismatch errors specifically
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch (tokenError) {
                        // Jika token mismatch (biasanya karena pakai project sendiri), fallback ke anonymous
                        console.warn("Custom token mismatch (normal jika pakai project sendiri), fallback ke anonymous login.", tokenError.code);
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
                
                clearTimeout(timeout);
            } catch (error) {
                console.error("Auth Error (Fatal):", error);
                loadingText.innerText = `Gagal Login (${error.code}). Periksa API Key / Project ID.`;
                document.getElementById('forceConfigBtn').classList.remove('hidden');
                loadingText.classList.add('text-red-500');
            }
        }

        if(isConnected) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("Connected as:", user.uid);
                    document.getElementById('connectionStatusIndicator').classList.remove('bg-red-500');
                    document.getElementById('connectionStatusIndicator').classList.add('bg-green-500');
                    loadingText.innerText = "Mengambil data...";
                    subscribeToData();
                } else {
                    document.getElementById('connectionStatusIndicator').classList.remove('bg-green-500');
                    document.getElementById('connectionStatusIndicator').classList.add('bg-red-500');
                }
            });
        }

        function subscribeToData() {
            // Updated to use Safe Path
            const q = query(getCollectionRef());
            
            onSnapshot(q, (snapshot) => {
                const newData = [];
                snapshot.forEach((doc) => {
                    newData.push({ id: doc.id, ...doc.data() });
                });

                // Sort by Name
                newData.sort((a, b) => (a.nama || '').localeCompare(b.nama || ''));
                npwpData = newData;
                
                // Maintain Search
                const searchTerm = document.getElementById('searchName').value.toLowerCase();
                if (searchTerm) {
                    filteredData = npwpData.filter(r => (r.nama || '').toLowerCase().includes(searchTerm));
                } else {
                    filteredData = [...npwpData];
                }

                updateDisplay();
                loadingOverlay.style.display = 'none';
                
                // Logic to load first record if idle
                if (!isEditing && filteredData.length > 0 && inputs.nama.value === '') {
                    loadRecord(0);
                } else if (filteredData.length === 0) {
                    clearForm();
                }

            }, (error) => {
                console.error("Firestore Error:", error);
                loadingOverlay.style.display = 'none';
                let errMsg = "Error akses database.";
                if(error.code === 'permission-denied') errMsg += " Izin ditolak. Cek Rules di Firebase Console Anda.";
                else if(error.code === 'unavailable') errMsg += " Koneksi offline.";
                else errMsg += ` ${error.message}`;

                showMessageBox(errMsg);
                document.getElementById('forceConfigBtn').classList.remove('hidden');
            });
        }

        // --- 4. CRUD Operations ---

        document.getElementById('saveRecord').addEventListener('click', async () => {
            if (!validateForm()) return;

            loadingOverlay.style.display = 'flex';
            loadingText.innerText = "Menyimpan ke Cloud...";

            const recordData = {
                nama: inputs.nama.value,
                email: inputs.email.value,
                pasEmail: inputs.pasEmail.value,
                nik: inputs.nik.value,
                kk: inputs.kk.value,
                pasNPWP: inputs.pasNPWP.value,
                pasNPWPTerbaru: inputs.pasNPWPTerbaru.value,
                hasEmail: inputs.email.value.trim() !== ''
            };

            try {
                if (isEditing && currentDocId) {
                    await updateDoc(getDocRef(currentDocId), recordData);
                    showMessageBox('Data berhasil diperbarui!');
                } else {
                    recordData.createdAt = new Date().toISOString();
                    await addDoc(getCollectionRef(), recordData);
                    showMessageBox('Data baru berhasil ditambahkan!');
                    clearForm();
                }
            } catch (error) {
                showMessageBox("Gagal menyimpan: " + error.message);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        });

        window.deleteRecord = async (docId) => {
            showConfirmation("Yakin hapus data ini permanen?", async () => {
                loadingOverlay.style.display = 'flex';
                try {
                    await deleteDoc(getDocRef(docId));
                } catch (error) {
                    showMessageBox("Gagal hapus: " + error.message);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }, () => {});
        };

        // --- 5. UI Helpers ---

        function loadRecord(index) {
            if (index >= 0 && index < filteredData.length) {
                currentIndex = index;
                const record = filteredData[index];
                currentDocId = record.id;
                inputs.no.value = index + 1;
                inputs.nama.value = record.nama || '';
                inputs.email.value = record.email || '';
                inputs.pasEmail.value = record.pasEmail || '';
                inputs.nik.value = record.nik || '';
                inputs.kk.value = record.kk || '';
                inputs.pasNPWP.value = record.pasNPWP || '';
                inputs.pasNPWPTerbaru.value = record.pasNPWPTerbaru || '';
                
                updateTableSelection(index);
                document.getElementById('currentRecord').textContent = `Record: ${index + 1} / ${filteredData.length}`;
            }
        }

        function clearForm() {
            Object.values(inputs).forEach(input => input.id !== 'no' ? input.value = '' : null);
            inputs.no.value = filteredData.length + 1;
            isEditing = false;
            currentDocId = null;
            document.getElementById('saveRecord').innerHTML = '<i class="fas fa-save mr-2"></i> SIMPAN DATA';
        }

        function updateDisplay() {
            const tableBody = document.getElementById('dataTable');
            const noDataDiv = document.getElementById('noData');
            
            document.getElementById('totalCount').innerText = `Total: ${npwpData.length}`;
            
            if (filteredData.length === 0) {
                tableBody.innerHTML = '';
                noDataDiv.classList.remove('hidden');
            } else {
                noDataDiv.classList.add('hidden');
                tableBody.innerHTML = filteredData.map((record, index) => `
                    <tr class="border-b border-gray-50 hover:bg-blue-50 cursor-pointer transition-colors ${index === currentIndex ? 'bg-blue-100' : ''}" onclick="window.selectRecord(${index})">
                        <td class="px-6 py-4 font-mono text-gray-500">${index + 1}</td>
                        <td class="px-6 py-4 font-semibold text-gray-700">${record.nama || '-'}</td>
                        <td class="px-6 py-4 text-gray-600">${record.email || '-'}</td>
                        <td class="px-6 py-4 font-mono text-xs text-gray-500">
                            <div>NIK: ${record.nik || '-'}</div>
                            <div>KK: ${record.kk || '-'}</div>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${record.hasEmail ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                ${record.hasEmail ? 'Lengkap' : 'Incomplete'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="event.stopPropagation(); window.editRecord(${index})" class="text-blue-500 hover:text-blue-700 mr-3" title="Edit"><i class="fas fa-edit"></i></button>
                            <button onclick="event.stopPropagation(); window.deleteRecord('${record.id}')" class="text-red-500 hover:text-red-700" title="Hapus"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`).join('');
            }
        }

        function updateTableSelection(index) {
            const rows = document.getElementById('dataTable').children;
            for(let i=0; i<rows.length; i++) {
                if(i === index) rows[i].className = "border-b border-blue-100 bg-blue-100 cursor-pointer";
                else rows[i].className = "border-b border-gray-50 hover:bg-blue-50 cursor-pointer transition-colors";
            }
        }

        function validateForm() {
            if (!inputs.nama.value.trim()) { showMessageBox('Nama wajib diisi!'); inputs.nama.focus(); return false; }
            if (!inputs.nik.value.trim()) { showMessageBox('NIK wajib diisi!'); inputs.nik.focus(); return false; }
            return true;
        }

        // --- 6. Event Listeners ---
        
        window.selectRecord = (index) => { loadRecord(index); isEditing = false; document.getElementById('saveRecord').innerHTML = '<i class="fas fa-save mr-2"></i> SIMPAN DATA'; };
        
        window.editRecord = (index) => {
            loadRecord(index); 
            isEditing = true;
            document.getElementById('saveRecord').innerHTML = '<i class="fas fa-sync-alt mr-2"></i> UPDATE DATA';
            document.getElementById('saveRecord').classList.remove('from-blue-600', 'to-indigo-600');
            document.getElementById('saveRecord').classList.add('from-indigo-600', 'to-purple-600');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        document.getElementById('addNewRecord').addEventListener('click', () => { clearForm(); inputs.nama.focus(); });
        document.getElementById('undoRecord').addEventListener('click', () => { if(filteredData.length>0) loadRecord(currentIndex); else clearForm(); });

        document.getElementById('searchName').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            filteredData = val === '' ? [...npwpData] : npwpData.filter(r => (r.nama || '').toLowerCase().includes(val));
            currentIndex = 0;
            updateDisplay();
        });

        // Email Missing Feature
        document.getElementById('emailMissing').addEventListener('click', () => {
            emailMissingData = npwpData.filter(r => !r.hasEmail || r.email.trim() === '');
            if (emailMissingData.length === 0) return showMessageBox('Semua data sudah lengkap!');
            document.getElementById('emailInputSection').classList.remove('hidden');
            loadEmailMissingRecord(0);
        });
        
        document.getElementById('closeEmailForm').addEventListener('click', () => document.getElementById('emailInputSection').classList.add('hidden'));

        let emailModeIndex = 0;
        function loadEmailMissingRecord(idx) {
            if(idx >= emailMissingData.length) idx = 0;
            if(idx < 0) idx = emailMissingData.length -1;
            emailModeIndex = idx;
            const rec = emailMissingData[emailModeIndex];
            document.getElementById('emailFormName').value = rec.nama;
            document.getElementById('emailFormEmail').value = '';
            document.getElementById('emailFormPassword').value = '';
            document.getElementById('emailStatusText').innerText = `${emailModeIndex+1}/${emailMissingData.length}`;
        }
        
        document.getElementById('emailNextRecord').addEventListener('click', () => loadEmailMissingRecord(emailModeIndex + 1));
        document.getElementById('emailPrevRecord').addEventListener('click', () => loadEmailMissingRecord(emailModeIndex - 1));
        
        document.getElementById('emailSaveRecord').addEventListener('click', async () => {
            if(!document.getElementById('emailCompleted').checked) return showMessageBox('Konfirmasi data valid dulu.');
            const email = document.getElementById('emailFormEmail').value;
            const pass = document.getElementById('emailFormPassword').value;
            if(!email) return showMessageBox('Email kosong.');
            
            const rec = emailMissingData[emailModeIndex];
            await updateDoc(getDocRef(rec.id), { email, pasEmail: pass, hasEmail: true });
            
            emailMissingData.splice(emailModeIndex, 1);
            if(emailMissingData.length === 0) {
                document.getElementById('emailInputSection').classList.add('hidden');
                showMessageBox('Selesai! Semua data lengkap.');
            } else loadEmailMissingRecord(emailModeIndex);
        });

        // --- 7. Settings Modal Logic (The "Ini Nama Projeknya" Fix) ---
        
        const settingsModal = document.getElementById('settingsModal');
        const openSettingsBtn = document.getElementById('openSettings');
        const forceConfigBtn = document.getElementById('forceConfigBtn');
        const closeSettingsBtn = document.getElementById('closeSettings');
        const configForm = document.getElementById('configForm');

        function openConfigModal() {
            document.getElementById('confProjectId').value = firebaseConfig.projectId;
            document.getElementById('confApiKey').value = firebaseConfig.apiKey;
            document.getElementById('confAppId').value = firebaseConfig.appId;
            settingsModal.style.display = 'block';
        }

        openSettingsBtn.addEventListener('click', openConfigModal);
        forceConfigBtn.addEventListener('click', openConfigModal);
        closeSettingsBtn.addEventListener('click', () => settingsModal.style.display = 'none');

        // Auto-fill other fields when Project ID changes
        document.getElementById('confProjectId').addEventListener('blur', (e) => {
            const pid = e.target.value.trim();
            if(pid) {
                // Heuristic for standard firebase projects
                if(document.getElementById('confAppId').value.includes('default')) {
                    // Can't guess App ID, but we can guess domains
                }
            }
        });

        configForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newPid = document.getElementById('confProjectId').value.trim();
            const newKey = document.getElementById('confApiKey').value.trim();
            const newAppId = document.getElementById('confAppId').value.trim();

            if(!newPid || !newKey) return showMessageBox('Project ID dan API Key wajib diisi.');

            const newConfig = {
                apiKey: newKey,
                authDomain: `${newPid}.firebaseapp.com`,
                projectId: newPid,
                storageBucket: `${newPid}.firebasestorage.app`,
                messagingSenderId: "1234567890", // Generic placeholder if not changed
                appId: newAppId
            };
            
            localStorage.setItem('npwp_firebase_config', JSON.stringify(newConfig));
            showMessageBox('Konfigurasi disimpan. Halaman akan dimuat ulang.');
            setTimeout(() => location.reload(), 1500);
        });

        document.getElementById('resetConfig').addEventListener('click', () => {
            localStorage.removeItem('npwp_firebase_config');
            location.reload();
        });

        // --- 8. CSV Import / Export Logic ---

        // Helper to convert CSV string to array
        function parseCSV(text) {
            const rows = text.split('\n').map(r => r.trim()).filter(r => r);
            if(rows.length < 2) return [];
            // Assuming simple CSV (comma separated, no quotes handling for simplicity)
            // Skip header (row 0)
            return rows.slice(1).map(row => {
                const cols = row.split(',').map(c => c.trim());
                // Expected Order: No, Nama, Email, PassEmail, NIK, KK, PassNPWP, PassNPWP Terbaru
                return {
                    nama: cols[1] || '',
                    email: cols[2] || '',
                    pasEmail: cols[3] || '',
                    nik: cols[4] || '',
                    kk: cols[5] || '',
                    pasNPWP: cols[6] || '',
                    pasNPWPTerbaru: cols[7] || '',
                    hasEmail: (cols[2] || '').length > 0
                };
            });
        }

        // Handle Export
        document.getElementById('exportExcel').addEventListener('click', () => {
            if(npwpData.length === 0) return showMessageBox('Tidak ada data untuk diekspor.');
            
            // Header
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "No,Nama,Email,Password Email,NIK,KK,Password NPWP,Password NPWP Terbaru,Status\n";
            
            // Rows
            npwpData.forEach((row, index) => {
                const rowString = [
                    index + 1,
                    `"${(row.nama || '').replace(/"/g, '""')}"`, // Handle commas in names
                    row.email || '',
                    row.pasEmail || '',
                    `'${row.nik || ''}`, // Force string for excel
                    `'${row.kk || ''}`, // Force string for excel
                    row.pasNPWP || '',
                    row.pasNPWPTerbaru || '',
                    row.hasEmail ? 'Lengkap' : 'Incomplete'
                ].join(",");
                csvContent += rowString + "\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "data_npwp_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Handle Import
        document.getElementById('importExcel').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            
            loadingOverlay.style.display = 'flex';
            loadingText.innerText = "Membaca file CSV...";
            
            const reader = new FileReader();
            reader.onload = async (evt) => {
                const text = evt.target.result;
                const records = parseCSV(text);
                
                if(records.length === 0) {
                    loadingOverlay.style.display = 'none';
                    return showMessageBox('File kosong atau format salah.');
                }
                
                let successCount = 0;
                for(let i = 0; i < records.length; i++) {
                    const rec = records[i];
                    loadingText.innerText = `Mengimpor ${i+1}/${records.length}...`;
                    
                    if(!rec.nama || !rec.nik) continue; // Skip invalid records
                    
                    try {
                        rec.createdAt = new Date().toISOString();
                        await addDoc(getCollectionRef(), rec);
                        successCount++;
                    } catch(err) {
                        console.error("Import fail:", err);
                    }
                }
                
                loadingOverlay.style.display = 'none';
                showMessageBox(`Berhasil mengimpor ${successCount} data!`);
                e.target.value = ''; // Reset input
            };
            reader.readAsText(file);
        });

        // Helpers
        const showMessageBox = (msg) => {
            document.getElementById('modalMessage').innerText = msg;
            document.getElementById('messageModal').style.display = 'block';
        }
        
        const showConfirmation = (msg, onYes, onNo) => {
            document.getElementById('confirmMessage').innerText = msg;
            const modal = document.getElementById('confirmModal');
            modal.style.display = 'block';
            
            const yesBtn = document.getElementById('confirmYes');
            const noBtn = document.getElementById('confirmNo');
            const newYes = yesBtn.cloneNode(true);
            const newNo = noBtn.cloneNode(true);
            yesBtn.parentNode.replaceChild(newYes, yesBtn);
            noBtn.parentNode.replaceChild(newNo, noBtn);
            
            newYes.addEventListener('click', () => { onYes(); modal.style.display = 'none'; });
            newNo.addEventListener('click', () => { onNo(); modal.style.display = 'none'; });
        }

        // --- Start ---
        initApp();

    </script>
</body>
</html>
