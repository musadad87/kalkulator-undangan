<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Nota dengan LocalStorage - MUSADAD.COM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .print-area { background: white; }
        .invoice-table th, .invoice-table td { border: 1px solid black; }

        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
            }
            /* Menyesuaikan warna untuk cetak */
            .print-area .bg-yellow-200 { background-color: #fce76b !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
            .print-area .text-blue-600 { color: #2563eb !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
            .print-area .text-red-600 { color: #dc2626 !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-4">
        <!-- Header -->
        <div class="bg-blue-600 text-white p-4 rounded-t-lg">
            <h1 class="text-2xl font-bold">Aplikasi Nota Percetakan dengan LocalStorage</h1>
            <p class="text-blue-100">MUSADAD.COM - Ringan dan Cepat</p>
        </div>

        <div class="flex gap-4 bg-white rounded-b-lg shadow-lg">
            <!-- Left Panel - Invoice Creation -->
            <div class="flex-1 p-6">
                <div class="print-area">
                    <!-- Invoice Header Section -->
                    <div class="flex justify-between items-start mb-6">
                        <div class="w-1/2">
                            <h2 class="text-xl font-bold text-gray-800">MUSADAD.COM</h2>
                            <p class="text-xs text-gray-600">PERCETAKAN</p>
                            <p class="text-[10px] text-gray-600 mt-2">Jl. Rp.Garendong - cisema Petir, Kab.Serang BANTEN<br>Tlp. 083812352663<br>Email. musadad08@gmail.com</p>
                        </div>
                        <div class="w-1/2 text-right">
                            <div class="flex justify-end gap-2 text-xs mb-2 items-center">
                                <label class="font-medium text-gray-700 text-base">Tanggal</label>
                                <input type="text" id="invoiceDateDisplay" class="border border-black px-1" readonly>
                            </div>
                            <div class="flex justify-end gap-2 text-xs items-center">
                                <label class="font-medium text-gray-700 text-base">Tuan</label>
                                <input type="text" id="customerNameInput" class="border border-black px-1" placeholder="Nama Pelanggan">
                            </div>
                            <div class="flex justify-end gap-2 text-xs mt-2 items-center">
                                <label class="font-medium text-gray-700 text-base">Tlp.</label>
                                <input type="text" id="customerPhoneInput" class="border border-black px-1" placeholder="No. Telepon">
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center mb-4">
                        <label class="text-xs font-medium text-gray-700 mr-2">NO NOTA:</label>
                        <input type="text" id="invoiceNumber" class="border border-black w-24 px-1" readonly>
                    </div>

                    <!-- Items Table -->
                    <div class="mb-6">
                        <table class="w-full border-collapse invoice-table">
                            <thead class="bg-yellow-200">
                                <tr class="border border-black">
                                    <th class="border border-black p-2 text-center w-20">BANYAK</th>
                                    <th class="border border-black p-2 text-left">NAMA BARANG</th>
                                    <th class="border border-black p-2 text-right w-24">HARGA</th>
                                    <th class="border border-black p-2 text-right w-24">JUMLAH</th>
                                    <th class="border border-black p-2 text-center w-12"></th>
                                </tr>
                            </thead>
                            <tbody id="itemsTable">
                                <!-- Default row for new invoices -->
                                <tr>
                                    <td class="border border-black p-1 text-center">
                                        <input type="number" class="w-full p-1 border-0 text-center quantity-input" value="0" min="0">
                                    </td>
                                    <td class="border border-black p-1">
                                        <input type="text" class="w-full p-1 border-0 item-name" placeholder="Nama barang/jasa">
                                    </td>
                                    <td class="border border-black p-1">
                                        <input type="number" class="w-full p-1 border-0 text-right item-price" placeholder="0" min="0">
                                    </td>
                                    <td class="border border-black p-1 text-right item-total font-medium">Rp 0</td>
                                    <td class="border border-black p-1 text-center">
                                        <button onclick="removeItem(this)" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <button onclick="addItem()" class="mt-2 bg-green-500 text-white px-4 py-1 rounded hover:bg-green-600 text-sm">+ Tambah Item</button>
                    </div>

                    <!-- Ringkasan & Peringatan -->
                    <div class="flex justify-between items-end mb-6">
                        <div class="flex-1 mr-4">
                            <p class="text-sm font-medium mb-1">Diterima,</p>
                            <div class="h-16 border-b border-black"></div>
                            <div class="mt-2 text-sm text-center font-bold">( ................ )</div>
                        </div>
                        <div class="flex-1">
                            <div class="grid grid-cols-2 gap-1 mb-1">
                                <span class="text-sm font-medium">Jumlah Rp.</span>
                                <input type="text" id="totalAmount" readonly class="border border-black px-1 text-right font-bold bg-gray-100">
                            </div>
                            <div class="grid grid-cols-2 gap-1 mb-1">
                                <span class="text-sm font-medium">Uang Muka Rp.</span>
                                <input type="number" id="downPayment" class="border border-black px-1 text-right" min="0">
                            </div>
                            <div class="grid grid-cols-2 gap-1">
                                <span class="text-sm font-medium">Kurang Rp.</span>
                                <input type="text" id="remainingAmount" readonly class="border border-black px-1 text-right font-bold text-red-600 bg-gray-100">
                            </div>
                        </div>
                    </div>

                    <!-- Payment Info & Warning -->
                    <div class="mt-6 border-t border-black pt-4 flex justify-between items-start">
                        <div class="w-1/2 mr-4">
                            <p class="text-sm font-bold">PEMBAYARAN BISA MELALUI</p>
                            <div class="text-xs mt-2">
                                <p>Transfer ke:</p>
                                <p>NOREK BANK BCA</p>
                                <p class="font-bold">5410927839 ROHMATULLOH AL MUSADAD</p>
                            </div>
                        </div>
                        <div class="w-1/2 border border-red-500 bg-red-100 rounded p-2 text-center text-xs">
                            <p class="text-red-800 font-bold">PERHATIAN !!!</p>
                            <p class="text-red-600 mt-1">Barang-barang yang sudah dibeli tidak bisa ditukar / dikembalikan</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Database Controls -->
            <div class="w-96 p-6 bg-gray-50 border-l">
                <!-- Database Status -->
                <div class="mb-6 bg-green-100 border border-green-300 rounded p-3">
                    <h3 class="text-lg font-semibold text-green-800 mb-2">üìä Status Database</h3>
                    <p class="text-sm text-green-700">Total Records: <span id="dbRecordCount" class="font-bold">0</span></p>
                    <p class="text-sm text-green-700">Database: <span class="font-bold" id="dbStatus">Loading...</span></p>
                </div>

                <!-- Navigation Controls -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">Navigasi Data</h3>
                    <div class="flex justify-center gap-2 mb-4">
                        <button onclick="firstRecord()" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" title="First">‚èÆÔ∏è</button>
                        <button onclick="prevRecord()" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" title="Previous">‚è™</button>
                        <button onclick="nextRecord()" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" title="Next">‚è©</button>
                        <button onclick="lastRecord()" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" title="Last">‚è≠Ô∏è</button>
                    </div>
                    <div class="text-center text-sm text-gray-600">
                        Record: <span id="currentRecord">0</span> of <span id="totalRecords">0</span>
                    </div>
                </div>

                <!-- Material Calculation Buttons -->
                <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded">
                    <h4 class="text-sm font-semibold text-blue-800 mb-3">Perhitungan Khusus Bahan Percetakan</h4>
                    <div class="grid grid-cols-1 gap-2">
                        <button onclick="calculateMaterial(1.6)" class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 text-sm">Hitung Bahan 1,6</button>
                        <button onclick="calculateMaterial(1.1)" class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 text-sm">Hitung Bahan 1,1</button>
                        <button onclick="openMaterialCalculator()" class="bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600 text-sm">HITUNG BAHAN</button>
                    </div>
                </div>

                <!-- CRUD Operations -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">Database Operations</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="newInvoice()" class="bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600 text-sm">üìÑ Baru</button>
                        <button onclick="saveInvoice()" id="saveButton" class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 text-sm">üíæ Simpan</button>
                        <button onclick="updateInvoice()" class="bg-yellow-500 text-white px-3 py-2 rounded hover:bg-yellow-600 text-sm">‚úèÔ∏è Update</button>
                        <button onclick="deleteInvoice()" class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600 text-sm">üóëÔ∏è Hapus</button>
                        <button onclick="printInvoice()" class="bg-purple-500 text-white px-3 py-2 rounded hover:bg-purple-600 text-sm">üñ®Ô∏è Cetak</button>
                        <button onclick="exportDatabase()" class="bg-indigo-500 text-white px-3 py-2 rounded hover:bg-indigo-600 text-sm">üì§ Export</button>
                    </div>
                </div>

                <!-- Search -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">Pencarian</h3>
                    <input type="text" id="searchInput" placeholder="Cari nota, nama, atau alamat..." class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 mb-2">
                    <button onclick="searchInvoices()" class="w-full bg-orange-500 text-white px-3 py-2 rounded hover:bg-orange-600 text-sm">üîç Cari</button>
                </div>

                <!-- Database Records List -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">Database Records</h3>
                    <div class="bg-white rounded border max-h-80 overflow-auto">
                        <table class="w-full text-xs">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="p-2 text-left border-b">No. Nota</th>
                                    <th class="p-2 text-left border-b">Tanggal</th>
                                    <th class="p-2 text-left border-b">Pelanggan</th>
                                    <th class="p-2 text-left border-b">Total</th>
                                    <th class="p-2 text-left border-b">Status</th>
                                </tr>
                            </thead>
                            <tbody id="databaseTable">
                                <!-- Records will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Database Management -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">Database Management</h3>
                    <div class="space-y-2">
                        <button onclick="clearDatabase()" class="w-full bg-red-600 text-white px-3 py-2 rounded hover:bg-red-700 text-sm">üóëÔ∏è Clear Database</button>
                        <button onclick="importDatabase()" class="w-full bg-gray-600 text-white px-3 py-2 rounded hover:bg-gray-700 text-sm">üì• Import Database</button>
                        <input type="file" id="importFile" class="hidden" accept=".json" onchange="handleImportFile(event)">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Database Management System menggunakan localStorage
        class InvoiceDatabase {
            constructor() {
                this.dbKey = 'musadad_invoices_ls';
                this.records = [];
                this.currentIndex = 0;
            }

            async init() {
                // localStorage tidak memerlukan inisialisasi asinkron, jadi kita muat data segera
                this.loadAllRecords();
                // Mengubah status UI
                document.getElementById('dbStatus').textContent = 'Aktif';
                return Promise.resolve();
            }
            
            // Metode untuk menyimpan data ke localStorage
            // Setiap kali ada perubahan, kita simpan seluruh array kembali ke localStorage
            _saveToLocalStorage() {
                localStorage.setItem(this.dbKey, JSON.stringify(this.records));
            }

            async create(invoiceData) {
                const newInvoice = {
                    id: crypto.randomUUID(), // ID unik untuk setiap nota
                    invoiceNumber: await this.generateInvoiceNumber(),
                    ...invoiceData,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                this.records.push(newInvoice);
                this._saveToLocalStorage();
                this.updateUI();
                return newInvoice.id;
            }

            async update(id, invoiceData) {
                const index = this.records.findIndex(r => r.id === id);
                if (index === -1) return false;
                
                const updatedInvoice = {
                    ...this.records[index],
                    ...invoiceData,
                    updatedAt: new Date().toISOString()
                };
                
                this.records[index] = updatedInvoice;
                this._saveToLocalStorage();
                this.updateUI();
                return true;
            }

            async read(id) {
                return this.records.find(r => r.id === id);
            }

            async delete(id) {
                const index = this.records.findIndex(r => r.id === id);
                if (index === -1) return false;
                
                this.records.splice(index, 1);
                this._saveToLocalStorage();
                this.updateUI();
                return true;
            }

            async loadAllRecords() {
                const storedData = localStorage.getItem(this.dbKey);
                this.records = storedData ? JSON.parse(storedData) : [];
                this.records.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); // Urutkan terbaru ke terlama
                this.updateUI();
            }

            async search(query) {
                const searchTerm = query.toLowerCase();
                const results = this.records.filter(record => 
                    record.invoiceNumber.toLowerCase().includes(searchTerm) ||
                    record.customerName.toLowerCase().includes(searchTerm) ||
                    record.customerPhone.toLowerCase().includes(searchTerm) ||
                    record.items.some(item => item.name.toLowerCase().includes(searchTerm))
                );
                return results;
            }

            async clear() {
                localStorage.removeItem(this.dbKey);
                this.records = [];
                this.updateUI();
                return true;
            }

            async exportData() {
                return this.records;
            }
            
            async importData(data) {
                if (!Array.isArray(data)) {
                    throw new Error('Format data tidak valid. Diperlukan array.');
                }
                this.records = data;
                this._saveToLocalStorage();
                this.updateUI();
            }

            async generateInvoiceNumber() {
                const lastNumber = this.records.length > 0 ? 
                    Math.max(...this.records.map(r => parseInt(r.invoiceNumber) || 0)) : 0;
                return String(lastNumber + 1);
            }

            updateUI() {
                const totalCount = this.records.length;
                document.getElementById('dbRecordCount').textContent = totalCount;
                document.getElementById('totalRecords').textContent = totalCount;
                document.getElementById('currentRecord').textContent = totalCount > 0 ? this.currentIndex + 1 : 0;
                this.populateTable(this.records);
            }

            populateTable(records) {
                const tbody = document.getElementById('databaseTable');
                tbody.innerHTML = '';
                
                records.forEach((record, index) => {
                    const row = tbody.insertRow();
                    const remaining = record.totalAmount - (record.downPayment || 0);
                    const status = remaining <= 0 ? 'Lunas' : 'Belum Lunas';
                    const statusColor = remaining <= 0 ? 'text-green-600' : 'text-red-600';

                    row.innerHTML = `
                        <td class="p-2 border-b cursor-pointer hover:bg-blue-50" onclick="db.loadRecordByIndex(${index})">${record.invoiceNumber}</td>
                        <td class="p-2 border-b">${new Date(record.invoiceDate).toLocaleDateString('id-ID')}</td>
                        <td class="p-2 border-b">${record.customerName}</td>
                        <td class="p-2 border-b">Rp ${record.totalAmount.toLocaleString('id-ID')}</td>
                        <td class="p-2 border-b ${statusColor} font-semibold">${status}</td>
                    `;
                });
            }

            async loadRecordByIndex(index) {
                if (index >= 0 && index < this.records.length) {
                    this.currentIndex = index;
                    const record = this.records[index];

                    // Populate form
                    document.getElementById('invoiceNumber').value = record.invoiceNumber;
                    document.getElementById('invoiceDateDisplay').value = new Date(record.invoiceDate).toLocaleDateString('id-ID', {day: '2-digit', month: '2-digit', year: 'numeric'});
                    document.getElementById('customerNameInput').value = record.customerName;
                    document.getElementById('customerPhoneInput').value = record.customerPhone;
                    document.getElementById('downPayment').value = record.downPayment || '';
                    document.getElementById('saveButton').textContent = 'üíæ Simpan';
                    document.getElementById('saveButton').onclick = saveInvoice;

                    // Populate items
                    const tbody = document.getElementById('itemsTable');
                    tbody.innerHTML = '';
                    
                    record.items.forEach(item => {
                        const row = tbody.insertRow();
                        const totalItemPrice = (item.quantity * item.price);
                        row.innerHTML = `
                            <tr>
                                <td class="border border-black p-1 text-center">
                                    <input type="number" class="w-full p-1 border-0 text-center quantity-input" value="${item.quantity}" min="0">
                                </td>
                                <td class="border border-black p-1">
                                    <input type="text" class="w-full p-1 border-0 item-name" value="${item.name}">
                                </td>
                                <td class="border border-black p-1">
                                    <input type="number" class="w-full p-1 border-0 text-right item-price" value="${item.price}" min="0">
                                </td>
                                <td class="border border-black p-1 text-right item-total font-medium">Rp ${totalItemPrice.toLocaleString('id-ID')}</td>
                                <td class="border border-black p-1 text-center">
                                    <button onclick="removeItem(this)" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `;
                    });
                    updateCalculations();
                    this.updateUI();
                }
            }

            // Navigation methods
            async first() {
                if (this.records.length > 0) {
                    await this.loadRecordByIndex(0);
                }
            }

            async previous() {
                if (this.currentIndex > 0) {
                    await this.loadRecordByIndex(this.currentIndex - 1);
                }
            }

            async next() {
                if (this.currentIndex < this.records.length - 1) {
                    await this.loadRecordByIndex(this.currentIndex + 1);
                }
            }

            async last() {
                if (this.records.length > 0) {
                    await this.loadRecordByIndex(this.records.length - 1);
                }
            }
        }

        // Initialize database
        const db = new InvoiceDatabase();
        
        // Initialize application after the database is ready
        document.addEventListener('DOMContentLoaded', async function() {
            await db.init();
            document.getElementById('invoiceDateDisplay').value = new Date().toLocaleDateString('id-ID', {day: '2-digit', month: '2-digit', year: 'numeric'});
            document.getElementById('invoiceNumber').value = await db.generateInvoiceNumber();
            
            // Add event listeners for automatic calculations
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('quantity-input') || 
                    e.target.classList.contains('item-price') || 
                    e.target.id === 'downPayment') {
                    updateCalculations();
                }
            });
        });

        // Form management functions
        function addItem() {
            const tbody = document.getElementById('itemsTable');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <tr>
                    <td class="border border-black p-1 text-center">
                        <input type="number" class="w-full p-1 border-0 text-center quantity-input" value="1" min="0">
                    </td>
                    <td class="border border-black p-1">
                        <input type="text" class="w-full p-1 border-0 item-name" placeholder="Nama barang/jasa">
                    </td>
                    <td class="border border-black p-1">
                        <input type="number" class="w-full p-1 border-0 text-right item-price" placeholder="0" min="0">
                    </td>
                    <td class="border border-black p-1 text-right item-total font-medium">Rp 0</td>
                    <td class="border border-black p-1 text-center">
                        <button onclick="removeItem(this)" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
            updateCalculations();
        }

        function removeItem(button) {
            button.closest('tr').remove();
            updateCalculations();
        }

        function updateCalculations() {
            const rows = document.querySelectorAll('#itemsTable tr');
            let total = 0;

            rows.forEach(row => {
                const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const itemTotal = quantity * price;
                
                row.querySelector('.item-total').textContent = `Rp ${itemTotal.toLocaleString('id-ID')}`;
                total += itemTotal;
            });

            document.getElementById('totalAmount').value = `Rp ${total.toLocaleString('id-ID')}`;
            
            const downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
            const remaining = total - downPayment;
            document.getElementById('remainingAmount').value = `Rp ${remaining.toLocaleString('id-ID')}`;
        }

        // Get form data
        function getFormData() {
            const items = [];
            const rows = document.querySelectorAll('#itemsTable tr');
            
            rows.forEach(row => {
                const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
                const name = row.querySelector('.item-name').value;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                
                if (name && quantity > 0) {
                    items.push({ quantity, name, price });
                }
            });

            const totalText = document.getElementById('totalAmount').value;
            const totalAmount = parseFloat(totalText.replace(/[^\d]/g, '')) || 0;
            const invoiceNumber = document.getElementById('invoiceNumber').value;
            
            return {
                id: db.records.find(r => r.invoiceNumber === invoiceNumber)?.id,
                invoiceNumber: invoiceNumber,
                invoiceDate: new Date().toISOString().split('T')[0],
                customerName: document.getElementById('customerNameInput').value,
                customerPhone: document.getElementById('customerPhoneInput').value,
                items: items,
                totalAmount: totalAmount,
                downPayment: parseFloat(document.getElementById('downPayment').value) || 0
            };
        }

        // Database operation functions
        async function newInvoice() {
            document.getElementById('invoiceNumber').value = await db.generateInvoiceNumber();
            document.getElementById('invoiceDateDisplay').value = new Date().toLocaleDateString('id-ID', {day: '2-digit', month: '2-digit', year: 'numeric'});
            document.getElementById('customerNameInput').value = '';
            document.getElementById('customerPhoneInput').value = '';
            document.getElementById('downPayment').value = '';
            
            const tbody = document.getElementById('itemsTable');
            tbody.innerHTML = `
                <tr>
                    <td class="border border-black p-1 text-center">
                        <input type="number" class="w-full p-1 border-0 text-center quantity-input" value="1" min="0">
                    </td>
                    <td class="border border-black p-1">
                        <input type="text" class="w-full p-1 border-0 item-name" placeholder="Nama barang/jasa">
                    </td>
                    <td class="border border-black p-1">
                        <input type="number" class="w-full p-1 border-0 text-right item-price" placeholder="0" min="0">
                    </td>
                    <td class="border border-black p-1 text-right item-total font-medium">Rp 0</td>
                    <td class="border border-black p-1 text-center">
                        <button onclick="removeItem(this)" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
            updateCalculations();
            
            showCustomMessage('Nota baru telah dibuat! Silakan isi data dan klik Simpan.');
        }

        async function saveInvoice() {
            const formData = getFormData();
            
            if (!formData.customerName) {
                showCustomMessage('Mohon isi nama pelanggan!');
                return;
            }
            
            if (formData.items.length === 0) {
                showCustomMessage('Mohon tambahkan minimal satu item!');
                return;
            }

            try {
                const id = await db.create(formData);
                showCustomMessage(`Nota berhasil disimpan dengan ID: ${id}`);
            } catch (error) {
                showCustomMessage('Gagal menyimpan nota! Coba lagi.');
                console.error('Save error:', error);
            }
        }

        async function updateInvoice() {
            const formData = getFormData();
            
            if (!formData.id) {
                showCustomMessage('Tidak ada nota yang dipilih untuk diupdate!');
                return;
            }

            if (!formData.customerName) {
                showCustomMessage('Mohon isi nama pelanggan!');
                return;
            }
            
            try {
                const success = await db.update(formData.id, formData);
                if (success) {
                    showCustomMessage('Nota berhasil diupdate!');
                } else {
                    showCustomMessage('Gagal mengupdate nota!');
                }
            } catch (error) {
                showCustomMessage('Gagal mengupdate nota! Coba lagi.');
                console.error('Update error:', error);
            }
        }

        async function deleteInvoice() {
            const formData = getFormData();
            
            if (!formData.id) {
                showCustomMessage('Tidak ada nota yang dipilih untuk dihapus!');
                return;
            }

            const isConfirmed = await new Promise(resolve => {
                showCustomMessageWithConfirmation('Yakin ingin menghapus nota ini dari database?', resolve);
            });

            if (isConfirmed) {
                try {
                    const success = await db.delete(formData.id);
                    if (success) {
                        newInvoice();
                        showCustomMessage('Nota berhasil dihapus dari database!');
                    } else {
                        showCustomMessage('Gagal menghapus nota!');
                    }
                } catch (error) {
                    showCustomMessage('Gagal menghapus nota! Coba lagi.');
                    console.error('Delete error:', error);
                }
            }
        }

        function printInvoice() {
            const formData = getFormData();
            
            if (!formData.customerName) {
                showCustomMessage('Mohon isi nama pelanggan terlebih dahulu!');
                return;
            }

            const printWindow = window.open('', '_blank', 'width=600,height=800');
            
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Nota - ${formData.invoiceNumber}</title>
                    <style>
                        @page { size: A5; margin: 0; }
                        body { font-family: 'Arial', sans-serif; font-size: 10px; margin: 0; padding: 20mm; box-sizing: border-box; }
                        .nota-container { width: 100%; height: auto; position: relative; }
                        
                        .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
                        .header-left { width: 60%; }
                        .header-right { width: 40%; text-align: right; }
                        .logo-text { font-size: 16px; font-weight: bold; margin-bottom: 2px; color: #2563eb; }
                        .company-info { font-size: 8px; line-height: 1.2; }
                        
                        .info-row { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 4px; }
                        .info-label { font-weight: bold; margin-right: 5px; font-size: 14px; }
                        .info-value { border-bottom: 1px solid black; padding: 0 5px; font-size: 12px; }
                        
                        .invoice-number-section { display: flex; align-items: center; font-size: 10px; margin-bottom: 10px; }
                        .invoice-number-label { margin-right: 5px; }
                        .invoice-number-value { border-bottom: 1px solid black; padding: 0 5px; }

                        .items-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
                        .items-table th, .items-table td { border: 1px solid black; padding: 4px; }
                        .items-table th { background-color: #fce76b; text-align: center; }
                        .qty-col { width: 15%; text-align: center; }
                        .item-col { width: 45%; }
                        .price-col { width: 20%; text-align: right; }
                        .total-col { width: 20%; text-align: right; }
                        
                        .summary-warning-section { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; }
                        .summary-box { border-collapse: collapse; width: 40%; }
                        .summary-box td { border: 1px solid black; padding: 4px; }
                        .warning-box { border: 1px solid #dc2626; background-color: #fecaca; padding: 6px; text-align: center; font-size: 8px; width: 40%; }
                        .warning-title { font-weight: bold; color: #b91c1c; margin-bottom: 2px; }

                        .footer-section { display: flex; align-items: flex-end; justify-content: space-between; margin-top: 10px; }
                        .footer-left { width: 30%; }
                        
                        .payment-info { margin-top: 15px; font-size: 9px; }
                        .payment-info p { margin: 2px 0; }

                        /* Memastikan warna cetak */
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                                color-adjust: exact;
                            }
                            .logo-text {
                                color: #2563eb !important;
                            }
                            .items-table th {
                                background-color: #fce76b !important;
                            }
                            .warning-box {
                                border-color: #dc2626 !important;
                                background-color: #fecaca !important;
                            }
                            .warning-title {
                                color: #b91c1c !important;
                            }
                            .text-red-600 {
                                color: #dc2626 !important;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="nota-container">
                        
                        <div class="header">
                            <div class="header-left">
                                <div class="logo-text">MUSADAD.COM</div>
                                <div class="company-info">
                                    PERCETAKAN<br>
                                    Jl. Rp.Garendong - cisema Petir,<br>
                                    Kab.Serang BANTEN<br>
                                    Tlp. 083812352663<br>
                                    Email. musadad08@gmail.com
                                </div>
                            </div>
                            <div class="header-right">
                                <div class="info-row">
                                    <span class="info-label">Tanggal</span>
                                    <span class="info-value">${new Date().toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' })}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Tuan</span>
                                    <span class="info-value">${formData.customerName}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Tlp.</span>
                                    <span class="info-value">${formData.customerPhone}</span>
                                </div>
                            </div>
                        </div>

                        <div class="invoice-number-section">
                            <span class="invoice-number-label">NO NOTA:</span>
                            <span class="invoice-number-value">${formData.invoiceNumber}</span>
                        </div>

                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th class="qty-col">BANYAK</th>
                                    <th class="item-col">NAMA BARANG</th>
                                    <th class="price-col">HARGA</th>
                                    <th class="total-col">JUMLAH</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${formData.items.map(item => `
                                    <tr>
                                        <td class="qty-col">${item.quantity}</td>
                                        <td class="item-col">${item.name}</td>
                                        <td class="price-col">Rp ${item.price.toLocaleString('id-ID')}</td>
                                        <td class="total-col">Rp ${(item.quantity * item.price).toLocaleString('id-ID')}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        <div class="summary-warning-section">
                            <div class="warning-box">
                                <div class="warning-title">PERHATIAN !!!</div>
                                <p>Barang-barang yang sudah dibeli tidak bisa ditukar / dikembalikan</p>
                            </div>
                            <table class="summary-box">
                                <tr>
                                    <td>Jumlah Rp.</td>
                                    <td class="text-right">Rp ${formData.totalAmount.toLocaleString('id-ID')}</td>
                                </tr>
                                <tr>
                                    <td>Uang Muka Rp.</td>
                                    <td class="text-right">Rp ${formData.downPayment.toLocaleString('id-ID')}</td>
                                </tr>
                                <tr>
                                    <td>Kurang Rp.</td>
                                    <td class="text-right font-bold text-red-600">Rp ${(formData.totalAmount - formData.downPayment).toLocaleString('id-ID')}</td>
                                </tr>
                            </table>
                        </div>

                        <div class="footer-section">
                            <div class="footer-left">
                                <p class="text-xs">Diterima,</p>
                                <div class="w-full h-8 border-b border-black mt-4"></div>
                                <div class="mt-2 text-xs text-center font-bold">( ................ )</div>
                            </div>
                        </div>

                        <div class="payment-info">
                            <p><strong>PEMBAYARAN BISA MELALUI</strong></p>
                            <p class="mt-2">Transfer ke:</p>
                            <p>NOREK BANK BCA</p>
                            <p><strong>5410927839 ROHMATULLOH AL MUSADAD</strong></p>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        async function exportDatabase() {
            try {
                const data = await db.exportData();
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `musadad_invoices_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showCustomMessage('Database berhasil diekspor!');
            } catch (error) {
                showCustomMessage('Gagal mengekspor database!');
                console.error('Export error:', error);
            }
        }

        async function importDatabase() {
            document.getElementById('importFile').click();
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    await db.importData(importedData);
                    showCustomMessage('Data berhasil diimpor!');
                    newInvoice();
                } catch (error) {
                    showCustomMessage('Gagal mengimpor data. Pastikan file dalam format JSON yang benar.');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
        }

        async function searchInvoices() {
            const query = document.getElementById('searchInput').value;
            if (!query) {
                await db.loadAllRecords();
                return;
            }

            try {
                const results = await db.search(query);
                db.populateTable(results);
                showCustomMessage(`Ditemukan ${results.length} hasil pencarian.`);
            } catch (error) {
                showCustomMessage('Gagal melakukan pencarian.');
                console.error('Search error:', error);
            }
        }

        async function clearDatabase() {
            const isConfirmed = await new Promise(resolve => {
                showCustomMessageWithConfirmation('PERINGATAN: Ini akan menghapus SEMUA data dari database. Yakin ingin melanjutkan?', resolve, 'Hapus', 'Batal');
            });

            if (isConfirmed) {
                const isFinalConfirmed = await new Promise(resolve => {
                    showCustomMessageWithConfirmation('Konfirmasi sekali lagi: Semua data akan hilang permanen!', resolve, 'Ya, Hapus', 'Batalkan');
                });
                if (isFinalConfirmed) {
                    try {
                        const success = await db.clear();
                        if (success) {
                            newInvoice();
                            showCustomMessage('Database berhasil dikosongkan!');
                        } else {
                            showCustomMessage('Gagal mengosongkan database!');
                        }
                    } catch (error) {
                        showCustomMessage('Gagal mengosongkan database!');
                        console.error('Clear DB error:', error);
                    }
                }
            }
        }

        function showCustomMessage(message, type = 'info') {
            const overlay = document.createElement('div');
            overlay.id = 'messageOverlay';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000;';

            const box = document.createElement('div');
            box.style.cssText = 'background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); max-width: 350px; text-align: center;';

            const messageText = document.createElement('p');
            messageText.textContent = message;
            messageText.style.cssText = 'font-size: 1rem; color: #333; margin-bottom: 20px;';

            const closeButton = document.createElement('button');
            closeButton.textContent = 'OK';
            closeButton.style.cssText = 'background: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 9999px; font-weight: 600; cursor: pointer;';
            closeButton.onclick = () => overlay.remove();

            box.appendChild(messageText);
            box.appendChild(closeButton);
            overlay.appendChild(box);
            document.body.appendChild(overlay);
        }

        function showCustomMessageWithConfirmation(message, callback, confirmText = 'OK', cancelText = 'Batal') {
            const overlay = document.createElement('div');
            overlay.id = 'messageOverlay';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000;';

            const box = document.createElement('div');
            box.style.cssText = 'background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); max-width: 350px; text-align: center;';

            const messageText = document.createElement('p');
            messageText.textContent = message;
            messageText.style.cssText = 'font-size: 1rem; color: #333; margin-bottom: 20px;';

            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = 'display: flex; justify-content: space-around; gap: 10px;';
            
            const confirmButton = document.createElement('button');
            confirmButton.textContent = confirmText;
            confirmButton.style.cssText = 'background: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 9999px; font-weight: 600; cursor: pointer;';
            confirmButton.onclick = () => {
                overlay.remove();
                callback(true);
            };

            const cancelButton = document.createElement('button');
            cancelButton.textContent = cancelText;
            cancelButton.style.cssText = 'background: #6b7280; color: white; padding: 10px 20px; border: none; border-radius: 9999px; font-weight: 600; cursor: pointer;';
            cancelButton.onclick = () => {
                overlay.remove();
                callback(false);
            };

            buttonContainer.appendChild(confirmButton);
            buttonContainer.appendChild(cancelButton);
            box.appendChild(messageText);
            box.appendChild(buttonContainer);
            overlay.appendChild(box);
            document.body.appendChild(overlay);
        }


        // Navigation functions
        function firstRecord() { db.first(); }
        function prevRecord() { db.previous(); }
        function nextRecord() { db.next(); }
        function lastRecord() { db.last(); }

        // Search on Enter key
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchInvoices();
            }
        });

        // Material calculation functions
        function calculateMaterial(width) {
            const length = prompt(`Masukkan panjang bahan (meter) untuk lebar ${width}m:`);
            if (length && !isNaN(length)) {
                const area = parseFloat(length) * width;
                const pricePerSqm = width === 1.6 ? 35000 : 40000;
                const totalPrice = area * pricePerSqm;
                
                const rows = document.querySelectorAll('#itemsTable tr');
                const lastRow = rows[rows.length - 1];
                
                if (lastRow.querySelector('.item-name').value === '') {
                    lastRow.querySelector('.quantity-input').value = area.toFixed(2);
                    lastRow.querySelector('.item-name').value = `Bahan ${width}m x ${length}m`;
                    lastRow.querySelector('.item-price').value = pricePerSqm;
                } else {
                    addItem();
                    const newRows = document.querySelectorAll('#itemsTable tr');
                    const newRow = newRows[newRows.length - 1];
                    newRow.querySelector('.quantity-input').value = area.toFixed(2);
                    newRow.querySelector('.item-name').value = `Bahan ${width}m x ${length}m`;
                    newRow.querySelector('.item-price').value = pricePerSqm;
                }
                
                updateCalculations();
                showCustomMessage(`Perhitungan: ${length}m x ${width}m = ${area.toFixed(2)}m¬≤\nHarga: Rp ${totalPrice.toLocaleString('id-ID')}`);
            }
        }

        function openMaterialCalculator() {
            const calculator = `
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 400px;">
                    <h3 style="margin-bottom: 15px; color: #1f2937;">Kalkulator Bahan Percetakan</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Lebar Bahan:</label>
                        <select id="calcWidth" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                            <option value="1.6">1.6 meter (Rp 35.000/m¬≤)</option>
                            <option value="1.1">1.1 meter (Rp 40.000/m¬≤)</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Panjang (meter):</label>
                        <input type="number" id="calcLength" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" step="0.1">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Harga per m¬≤ (Rp):</label>
                        <input type="number" id="calcPrice" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" value="35000">
                    </div>
                    
                    <div style="margin-bottom: 15px; padding: 10px; background: #f3f4f6; border-radius: 4px;">
                        <p style="margin: 0; font-weight: 500;">Hasil Perhitungan:</p>
                        <p id="calcResult" style="margin: 5px 0 0 0; color: #059669;">Luas: 0 m¬≤ | Total: Rp 0</p>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="addCalculatedMaterial()" style="flex: 1; background: #10b981; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer;">Tambah ke Nota</button>
                        <button onclick="closeCalculator()" style="flex: 1; background: #6b7280; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer;">Tutup</button>
                    </div>
                </div>
            `;
            
            const overlay = document.createElement('div');
            overlay.id = 'calculatorOverlay';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;';
            overlay.innerHTML = calculator;
            document.body.appendChild(overlay);
            
            document.getElementById('calcWidth').addEventListener('change', function() {
                const width = this.value;
                if (width === '1.6') {
                    document.getElementById('calcPrice').value = 35000;
                } else if (width === '1.1') {
                    document.getElementById('calcPrice').value = 40000;
                } else {
                    document.getElementById('calcPrice').value = '';
                }
                updateCalcResult();
            });
            
            document.getElementById('calcLength').addEventListener('input', updateCalcResult);
            document.getElementById('calcPrice').addEventListener('input', updateCalcResult);
            
            function updateCalcResult() {
                const width = parseFloat(document.getElementById('calcWidth').value) || 0;
                const length = parseFloat(document.getElementById('calcLength').value) || 0;
                const price = parseFloat(document.getElementById('calcPrice').value) || 0;
                const area = width * length;
                const total = area * price;
                
                document.getElementById('calcResult').textContent = 
                    `Luas: ${area.toFixed(2)} m¬≤ | Total: Rp ${total.toLocaleString('id-ID')}`;
            }
        }

        function addCalculatedMaterial() {
            const width = document.getElementById('calcWidth').value;
            const length = parseFloat(document.getElementById('calcLength').value) || 0;
            const price = parseFloat(document.getElementById('calcPrice').value) || 0;
            
            if (length <= 0) {
                showCustomMessage('Mohon masukkan panjang yang valid!');
                return;
            }
            
            const area = parseFloat(width) * length;
            
            const rows = document.querySelectorAll('#itemsTable tr');
            const lastRow = rows[rows.length - 1];
            
            if (lastRow.querySelector('.item-name').value === '') {
                lastRow.querySelector('.quantity-input').value = area.toFixed(2);
                lastRow.querySelector('.item-name').value = `Bahan ${width}m x ${length}m`;
                lastRow.querySelector('.item-price').value = price;
            } else {
                addItem();
                const newRows = document.querySelectorAll('#itemsTable tr');
                const newRow = newRows[newRows.length - 1];
                newRow.querySelector('.quantity-input').value = area.toFixed(2);
                newRow.querySelector('.item-name').value = `Bahan ${width}m x ${length}m`;
                newRow.querySelector('.item-price').value = price;
            }
            
            updateCalculations();
            closeCalculator();
            showCustomMessage('Bahan berhasil ditambahkan ke nota!');
        }

        function closeCalculator() {
            const overlay = document.getElementById('calculatorOverlay');
            if (overlay) {
                overlay.remove();
            }
        }
    </script>
</body>
</html>
