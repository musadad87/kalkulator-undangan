<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Nota dengan Firestore - MUSADAD.COM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .print-area { background: white; }
        .invoice-table th, .invoice-table td { border: 1px solid black; }

        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            /* Adjusting colors for printing */
            .print-area .bg-yellow-200 { background-color: #fce76b !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
            .print-area .text-red-600 { color: #dc2626 !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-4">
        <!-- Header -->
        <div class="bg-blue-600 text-white p-4 rounded-t-lg">
            <h1 class="text-2xl font-bold">Aplikasi Nota Percetakan dengan Firestore</h1>
            <p class="text-blue-100">MUSADAD.COM - Ringan dan Cepat</p>
        </div>

        <div class="flex flex-col lg:flex-row gap-4 bg-white rounded-b-lg shadow-lg">
            <!-- Left Panel - Invoice Creation -->
            <div class="flex-1 p-6">
                <div class="print-area">
                    <!-- Invoice Header Section -->
                    <div class="flex justify-between items-start mb-6">
                        <div class="w-1/2">
                            <h2 class="text-2xl font-extrabold text-red-600">MUSADAD.COM</h2>
                            <p class="text-sm font-semibold text-gray-700">PERCETAKAN</p>
                            <p class="text-xs text-gray-600 mt-2">Jl. Rp.Garendong - cisema Petir, Kab.Serang BANTEN<br>Tlp. 083812352663<br>Email. musadad08@gmail.com</p>
                        </div>
                        <div class="w-1/2 text-right">
                            <div class="flex justify-end gap-2 text-xs mb-2 items-center">
                                <label class="font-medium text-gray-700 text-base">Tanggal</label>
                                <input type="text" id="invoiceDateDisplay" class="border border-black px-1" readonly>
                            </div>
                            <div class="flex justify-end gap-2 text-xs items-center">
                                <label class="font-medium text-gray-700 text-base">Tuan</label>
                                <input type="text" id="customerNameInput" class="border border-black px-1" placeholder="Nama Pelanggan">
                            </div>
                            <div class="flex justify-end gap-2 text-xs mt-2 items-center">
                                <label class="font-medium text-gray-700 text-base">Tlp.</label>
                                <input type="text" id="customerPhoneInput" class="border border-black px-1" placeholder="No. Telepon">
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center mb-4">
                        <label class="text-xs font-medium text-gray-700 mr-2">NO NOTA:</label>
                        <input type="text" id="invoiceNumber" class="border border-black w-36 px-1" readonly>
                    </div>

                    <!-- Items Table -->
                    <div class="mb-6">
                        <table class="w-full border-collapse invoice-table">
                            <thead class="bg-yellow-200">
                                <tr class="border border-black">
                                    <th class="border border-black p-2 text-center w-20">BANYAK</th>
                                    <th class="border border-black p-2 text-left">NAMA BARANG</th>
                                    <th class="border border-black p-2 text-right w-24">HARGA</th>
                                    <th class="border border-black p-2 text-right w-24">JUMLAH</th>
                                    <th class="border border-black p-2 text-center w-12"></th>
                                </tr>
                            </thead>
                            <tbody id="itemsTable">
                                <!-- Default row for new invoices -->
                                <tr>
                                    <td class="border border-black p-1 text-center">
                                        <input type="number" class="w-full p-1 border-0 text-center quantity-input" value="0" min="0">
                                    </td>
                                    <td class="border border-black p-1">
                                        <input type="text" class="w-full p-1 border-0 item-name" placeholder="Nama barang/jasa">
                                    </td>
                                    <td class="border border-black p-1">
                                        <input type="number" class="w-full p-1 border-0 text-right item-price" placeholder="0" min="0">
                                    </td>
                                    <td class="border border-black p-1 text-right item-total font-medium">Rp 0</td>
                                    <td class="border border-black p-1 text-center">
                                        <button onclick="removeItem(this)" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <button onclick="addItem()" class="mt-2 bg-green-500 text-white px-4 py-1 rounded hover:bg-green-600 text-sm">+ Tambah Item</button>
                    </div>

                    <!-- Ringkasan & Peringatan -->
                    <div class="flex justify-between items-end mb-6">
                        <div class="flex-1 mr-4">
                            <p class="text-sm font-medium mb-1">Diterima,</p>
                            <div class="h-16 border-b border-black"></div>
                            <div class="mt-2 text-sm text-center font-bold">( ................ )</div>
                        </div>
                        <div class="flex-1">
                            <div class="grid grid-cols-2 gap-1 mb-1">
                                <span class="text-sm font-medium">Jumlah Rp.</span>
                                <input type="text" id="totalAmount" readonly class="border border-black px-1 text-right font-bold bg-gray-100">
                            </div>
                            <div class="grid grid-cols-2 gap-1 mb-1">
                                <span class="text-sm font-medium">Uang Muka Rp.</span>
                                <input type="number" id="downPayment" class="border border-black px-1 text-right" min="0">
                            </div>
                            <div class="grid grid-cols-2 gap-1">
                                <span class="text-sm font-medium">Kurang Rp.</span>
                                <input type="text" id="remainingAmount" readonly class="border border-black px-1 text-right font-bold text-red-600 bg-gray-100">
                            </div>
                        </div>
                    </div>

                    <!-- Payment Info & Warning -->
                    <div class="mt-6 border-t border-black pt-4 flex justify-between items-start">
                        <div class="w-1/2 mr-4">
                            <p class="text-sm font-bold">PEMBAYARAN BISA MELALUI</p>
                            <div class="text-xs mt-2">
                                <p>Transfer ke:</p>
                                <p>NOREK BANK BCA</p>
                                <p class="font-bold">5410927839 ROHMATULLOH AL MUSADAD</p>
                            </div>
                        </div>
                        <div class="w-1/2 border border-red-500 bg-red-100 rounded p-2 text-center text-xs">
                            <p class="text-red-800 font-bold">PERHATIAN !!!</p>
                            <p class="text-red-600 mt-1">Barang-barang yang sudah dibeli tidak bisa ditukar / dikembalikan</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Database Controls -->
            <div class="w-full lg:w-96 p-6 bg-gray-50 border-l">
                <!-- Database Status -->
                <div class="mb-6 bg-green-100 border border-green-300 rounded p-3">
                    <h3 class="text-lg font-semibold text-green-800 mb-2">üìä Status Database</h3>
                    <p class="text-sm text-green-700">Total Records: <span id="dbRecordCount" class="font-bold">0</span></p>
                    <p class="text-sm text-green-700">Database: <span class="font-bold" id="dbStatus">Loading...</span></p>
                </div>

                <!-- Navigation Controls -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">Navigasi Data</h3>
                    <div class="flex justify-center gap-2 mb-4">
                        <button onclick="firstRecord()" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" title="First">‚èÆÔ∏è</button>
                        <button onclick="prevRecord()" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" title="Previous">‚è™</button>
                        <button onclick="nextRecord()" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" title="Next">‚è©</button>
                        <button onclick="lastRecord()" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" title="Last">‚è≠Ô∏è</button>
                    </div>
                    <div class="text-center text-sm text-gray-600">
                        Record: <span id="currentRecord">0</span> of <span id="totalRecords">0</span>
                    </div>
                </div>

                <!-- Material Calculation Buttons -->
                <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded">
                    <h4 class="text-sm font-semibold text-blue-800 mb-3">Perhitungan Khusus Bahan Percetakan</h4>
                    <div class="grid grid-cols-1 gap-2">
                        <button onclick="openMaterialCalculator()" class="bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600 text-sm">HITUNG BAHAN</button>
                    </div>
                </div>

                <!-- CRUD Operations -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">Database Operations</h3>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="newInvoice()" class="bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600 text-sm">üìÑ Baru</button>
                        <button onclick="saveInvoice()" id="saveButton" class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 text-sm">üíæ Simpan</button>
                        <button onclick="updateInvoice()" class="bg-yellow-500 text-white px-3 py-2 rounded hover:bg-yellow-600 text-sm">‚úèÔ∏è Update</button>
                        <button onclick="deleteInvoice()" class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600 text-sm">üóëÔ∏è Hapus</button>
                        <button onclick="printInvoice()" class="bg-purple-500 text-white px-3 py-2 rounded hover:bg-purple-600 text-sm">üñ®Ô∏è Cetak</button>
                    </div>
                </div>

                <!-- Backup & Restore -->
                <div class="mb-6 p-4 bg-gray-100 border border-gray-300 rounded">
                     <h3 class="text-lg font-semibold mb-3 text-gray-800">Backup & Restore Lokal</h3>
                     <p class="text-xs text-gray-600 mb-2">Fungsi ini memungkinkan Anda menyimpan cadangan data ke komputer dan memulihkannya kembali.</p>
                     <div class="grid grid-cols-1 gap-2">
                        <input type="file" id="fileInput" accept="application/json" class="hidden" onchange="handleImportFile(event)">
                        <button onclick="exportDatabase()" class="bg-cyan-500 text-white px-3 py-2 rounded hover:bg-cyan-600 text-sm">üì• Unduh Cadangan</button>
                        <button onclick="fetchData()" class="bg-teal-500 text-white px-3 py-2 rounded hover:bg-teal-600 text-sm">üì§ Pulihkan dari File</button>
                     </div>
                </div>


                <!-- Search -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">Pencarian</h3>
                    <input type="text" id="searchInput" placeholder="Cari nota, nama, atau alamat..." class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 mb-2">
                    <button onclick="searchInvoices()" class="w-full bg-orange-500 text-white px-3 py-2 rounded hover:bg-orange-600 text-sm">üîç Cari</button>
                </div>

                <!-- Database Records List -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">Database Records</h3>
                    <div class="bg-white rounded border max-h-80 overflow-auto">
                        <table class="w-full text-xs">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="p-2 text-left border-b">No. Nota</th>
                                    <th class="p-2 text-left border-b">Tanggal</th>
                                    <th class="p-2 text-left border-b">Pelanggan</th>
                                    <th class="p-2 text-left border-b">Total</th>
                                    <th class="p-2 text-left border-b">Status</th>
                                </tr>
                            </thead>
                            <tbody id="databaseTable">
                                <!-- Records will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, deleteDoc, query, where, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Global variables provided by the environment, do not modify
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : null);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;

        // Database Management System using Firestore
        class InvoiceDatabase {
            constructor() {
                this.records = [];
                this.currentIndex = 0;
                this.unsubscribe = null;
            }

            async init() {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    this.setupAuthListener();
                } catch (error) {
                    document.getElementById('dbStatus').textContent = 'Error';
                    console.error('Firebase initialization error:', error);
                    showCustomMessage('Gagal terhubung ke database. Cek konsol untuk detail.');
                }
            }

            setupAuthListener() {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('dbStatus').textContent = 'Aktif (Connected to Firestore)';
                        this.setupRealtimeListener();
                    } else {
                        userId = null;
                        this.records = [];
                        this.currentIndex = 0;
                        this.updateUI();
                        if (this.unsubscribe) {
                            this.unsubscribe();
                        }
                        document.getElementById('dbStatus').textContent = 'Disconnected';
                        showCustomMessage('Anda terputus dari database.');
                    }
                });
            }

            setupRealtimeListener() {
                const q = query(collection(db, 'artifacts', appId, 'users', userId, 'invoices'));
                this.unsubscribe = onSnapshot(q, (querySnapshot) => {
                    this.records = [];
                    querySnapshot.forEach((doc) => {
                        this.records.push({ ...doc.data(), id: doc.id });
                    });
                    this.records.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    this.updateUI();
                    if (this.records.length > 0) {
                         this.loadRecordByIndex(0);
                    } else {
                        window.newInvoice();
                    }
                }, (error) => {
                    console.error('Realtime listener error:', error);
                    showCustomMessage('Gagal mendengarkan perubahan database.');
                });
            }

            async create(invoiceData) {
                const docRef = await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'invoices'), {
                    ...invoiceData,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
                return docRef.id;
            }

            async update(id, invoiceData) {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'invoices', id);
                await updateDoc(docRef, {
                    ...invoiceData,
                    updatedAt: new Date().toISOString()
                });
                return true;
            }

            async delete(id) {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'invoices', id);
                await deleteDoc(docRef);
                return true;
            }

            async search(queryText) {
                const q = query(collection(db, 'artifacts', appId, 'users', userId, 'invoices'), where('customerName', '>=', queryText), where('customerName', '<=', queryText + '\uf8ff'));
                const querySnapshot = await getDocs(q);
                const results = [];
                querySnapshot.forEach((doc) => {
                    results.push({ ...doc.data(), id: doc.id });
                });
                return results;
            }

            async generateInvoiceNumber() {
                const today = new Date();
                const d = String(today.getDate()).padStart(2, '0');
                const m = String(today.getMonth() + 1).padStart(2, '0');
                const y = today.getFullYear();
                const datePrefix = `${d}${m}${y}`;

                const q = query(collection(db, 'artifacts', appId, 'users', userId, 'invoices'));
                const querySnapshot = await getDocs(q);
                const todayRecords = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.invoiceNumber.startsWith(datePrefix)) {
                        todayRecords.push(data);
                    }
                });
                
                let lastSeq = 0;
                if (todayRecords.length > 0) {
                    lastSeq = Math.max(...todayRecords.map(r => parseInt(r.invoiceNumber.slice(8)) || 0));
                }
                
                const newSeq = String(lastSeq + 1).padStart(3, '0');
                
                return `${datePrefix}${newSeq}`;
            }

            updateUI() {
                const totalCount = this.records.length;
                document.getElementById('dbRecordCount').textContent = totalCount;
                document.getElementById('totalRecords').textContent = totalCount;
                document.getElementById('currentRecord').textContent = totalCount > 0 ? this.currentIndex + 1 : 0;
                this.populateTable(this.records);
            }

            populateTable(records) {
                const tbody = document.getElementById('databaseTable');
                tbody.innerHTML = '';
                
                records.forEach((record, index) => {
                    const originalIndex = this.records.findIndex(r => r.id === record.id);
                    const row = tbody.insertRow();
                    const remaining = record.totalAmount - (record.downPayment || 0);
                    const status = remaining <= 0 ? 'Lunas' : 'Belum Lunas';
                    const statusColor = remaining <= 0 ? 'text-green-600' : 'text-red-600';

                    row.innerHTML = `
                        <td class="p-2 border-b cursor-pointer hover:bg-blue-50" onclick="db.loadRecordByIndex(${originalIndex})">${record.invoiceNumber}</td>
                        <td class="p-2 border-b">${new Date(record.invoiceDate).toLocaleDateString('id-ID')}</td>
                        <td class="p-2 border-b">${record.customerName}</td>
                        <td class="p-2 border-b">Rp ${record.totalAmount.toLocaleString('id-ID')}</td>
                        <td class="p-2 border-b ${statusColor} font-semibold">${status}</td>
                    `;
                });
            }

            async loadRecordByIndex(index) {
                if (index >= 0 && index < this.records.length) {
                    this.currentIndex = index;
                    const record = this.records[index];

                    document.getElementById('invoiceNumber').value = record.invoiceNumber;
                    document.getElementById('invoiceDateDisplay').value = new Date(record.invoiceDate).toLocaleDateString('id-ID', {day: '2-digit', month: '2-digit', year: 'numeric'});
                    document.getElementById('customerNameInput').value = record.customerName;
                    document.getElementById('customerPhoneInput').value = record.customerPhone;
                    document.getElementById('downPayment').value = record.downPayment || '';
                    
                    const tbody = document.getElementById('itemsTable');
                    tbody.innerHTML = '';
                    
                    record.items.forEach(item => {
                        const row = tbody.insertRow();
                        const totalItemPrice = (item.quantity * item.price);
                        row.innerHTML = `
                            <tr>
                                <td class="border border-black p-1 text-center"><input type="number" class="w-full p-1 border-0 text-center quantity-input" value="${item.quantity}" min="0"></td>
                                <td class="border border-black p-1"><input type="text" class="w-full p-1 border-0 item-name" value="${item.name}"></td>
                                <td class="border border-black p-1"><input type="number" class="w-full p-1 border-0 text-right item-price" value="${item.price}" min="0"></td>
                                <td class="border border-black p-1 text-right item-total font-medium">Rp ${totalItemPrice.toLocaleString('id-ID')}</td>
                                <td class="border border-black p-1 text-center"><button onclick="removeItem(this)" class="text-red-500 hover:text-red-700">üóëÔ∏è</button></td>
                            </tr>
                        `;
                    });
                    updateCalculations();
                    this.updateUI();
                }
            }

            async first() { if (this.records.length > 0) await this.loadRecordByIndex(0); }
            async previous() { if (this.currentIndex > 0) await this.loadRecordByIndex(this.currentIndex - 1); }
            async next() { if (this.currentIndex < this.records.length - 1) await this.loadRecordByIndex(this.currentIndex + 1); }
            async last() { if (this.records.length > 0) await this.loadRecordByIndex(this.records.length - 1); }
        }

        let dbInstance;

        // Corrected: Initialize the global `db` variable here
        document.addEventListener('DOMContentLoaded', async function() {
            dbInstance = new InvoiceDatabase();
            window.db = dbInstance; // Make it accessible globally
            await dbInstance.init();
            
            document.addEventListener('input', e => {
                if (e.target.classList.contains('quantity-input') || 
                    e.target.classList.contains('item-price') || 
                    e.target.id === 'downPayment') {
                    updateCalculations();
                }
            });
        });

        window.addItem = function() {
            const tbody = document.getElementById('itemsTable');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <tr>
                    <td class="border border-black p-1 text-center"><input type="number" class="w-full p-1 border-0 text-center quantity-input" value="1" min="0"></td>
                    <td class="border border-black p-1"><input type="text" class="w-full p-1 border-0 item-name" placeholder="Nama barang/jasa"></td>
                    <td class="border border-black p-1"><input type="number" class="w-full p-1 border-0 text-right item-price" placeholder="0" min="0"></td>
                    <td class="border border-black p-1 text-right item-total font-medium">Rp 0</td>
                    <td class="border border-black p-1 text-center"><button onclick="removeItem(this)" class="text-red-500 hover:text-red-700">üóëÔ∏è</button></td>
                </tr>
            `;
            updateCalculations();
        }

        window.removeItem = function(button) {
            button.closest('tr').remove();
            updateCalculations();
        }

        function updateCalculations() {
            let total = 0;
            document.querySelectorAll('#itemsTable tr').forEach(row => {
                const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const itemTotal = quantity * price;
                row.querySelector('.item-total').textContent = `Rp ${itemTotal.toLocaleString('id-ID')}`;
                total += itemTotal;
            });

            document.getElementById('totalAmount').value = `Rp ${total.toLocaleString('id-ID')}`;
            const downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
            const remaining = total - downPayment;
            document.getElementById('remainingAmount').value = `Rp ${remaining.toLocaleString('id-ID')}`;
        }

        function getFormData() {
            const items = [];
            document.querySelectorAll('#itemsTable tr').forEach(row => {
                const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
                const name = row.querySelector('.item-name').value;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                if (name && quantity > 0) items.push({ quantity, name, price });
            });

            const invoiceNumber = document.getElementById('invoiceNumber').value;
            // The `find` operation is now only used in update/delete, where an ID exists.
            const record = dbInstance.records.find(r => r.invoiceNumber === invoiceNumber);
            
            return {
                id: record ? record.id : null,
                invoiceNumber: invoiceNumber,
                invoiceDate: new Date().toISOString(),
                customerName: document.getElementById('customerNameInput').value,
                customerPhone: document.getElementById('customerPhoneInput').value,
                items: items,
                totalAmount: parseFloat(document.getElementById('totalAmount').value.replace(/[^\d]/g, '')) || 0,
                downPayment: parseFloat(document.getElementById('downPayment').value) || 0
            };
        }

        window.newInvoice = async function() {
            document.getElementById('invoiceNumber').value = await dbInstance.generateInvoiceNumber();
            document.getElementById('invoiceDateDisplay').value = new Date().toLocaleDateString('id-ID', {day: '2-digit', month: '2-digit', year: 'numeric'});
            document.getElementById('customerNameInput').value = '';
            document.getElementById('customerPhoneInput').value = '';
            document.getElementById('downPayment').value = '';
            
            const tbody = document.getElementById('itemsTable');
            tbody.innerHTML = `<tr><td class="border border-black p-1 text-center"><input type="number" class="w-full p-1 border-0 text-center quantity-input" value="1" min="0"></td><td class="border border-black p-1"><input type="text" class="w-full p-1 border-0 item-name" placeholder="Nama barang/jasa"></td><td class="border border-black p-1"><input type="number" class="w-full p-1 border-0 text-right item-price" placeholder="0" min="0"></td><td class="border border-black p-1 text-right item-total font-medium">Rp 0</td><td class="border border-black p-1 text-center"><button onclick="removeItem(this)" class="text-red-500 hover:text-red-700">üóëÔ∏è</button></td></tr>`;
            updateCalculations();
        }

        window.saveInvoice = async function() {
            const formData = getFormData();
            if (!formData.customerName) return showCustomMessage('Mohon isi nama pelanggan!');
            if (formData.items.length === 0) return showCustomMessage('Mohon tambahkan minimal satu item!');

            try {
                const id = await dbInstance.create(formData);
                showCustomMessage(`Nota berhasil disimpan!`);
            } catch (error) {
                showCustomMessage('Gagal menyimpan nota!');
                console.error('Save error:', error);
            }
        }

        window.updateInvoice = async function() {
            const formData = getFormData();
            if (!formData.id) return showCustomMessage('Tidak ada nota yang dipilih untuk diupdate!');
            if (!formData.customerName) return showCustomMessage('Mohon isi nama pelanggan!');
            
            try {
                const success = await dbInstance.update(formData.id, formData);
                showCustomMessage(success ? 'Nota berhasil diupdate!' : 'Gagal mengupdate nota!');
            } catch (error) {
                showCustomMessage('Gagal mengupdate nota!');
                console.error('Update error:', error);
            }
        }

        window.deleteInvoice = async function() {
            const formData = getFormData();
            if (!formData.id) return showCustomMessage('Tidak ada nota yang dipilih untuk dihapus!');

            const isConfirmed = await new Promise(resolve => showCustomMessageWithConfirmation('Yakin ingin menghapus nota ini?', resolve));
            if (isConfirmed) {
                try {
                    const success = await dbInstance.delete(formData.id);
                    if (success) {
                        showCustomMessage('Nota berhasil dihapus!');
                    } else {
                        showCustomMessage('Gagal menghapus nota!');
                    }
                } catch (error) {
                    showCustomMessage('Gagal menghapus nota!');
                    console.error('Delete error:', error);
                }
            }
        }

        window.printInvoice = function() {
            const formData = getFormData();
            if (!formData.customerName) return showCustomMessage('Mohon isi nama pelanggan terlebih dahulu!');

            const printWindow = window.open('', '_blank', 'width=600,height=800');
            const printContent = `
                <!DOCTYPE html><html><head><title>Nota - ${formData.invoiceNumber}</title><style>
                @page{size:A5;margin:0}body{font-family:'Arial',sans-serif;font-size:10px;margin:0;padding:15mm;box-sizing:border-box}.nota-container{width:100%;height:auto}.header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}.header-left{width:60%}.header-right{width:40%;text-align:right}.logo-text{font-size:16px;font-weight:bold;margin-bottom:2px;color:#dc2626}.company-info{font-size:8px;line-height:1.2}.info-row{display:flex;justify-content:flex-end;align-items:center;margin-bottom:4px}.info-label{font-weight:bold;margin-right:5px;font-size:12px}.info-value{border-bottom:1px solid #000;padding:0 5px;font-size:11px}.invoice-number-section{margin-bottom:10px}.items-table{width:100%;border-collapse:collapse;margin-bottom:10px}.items-table th,.items-table td{border:1px solid #000;padding:4px}.items-table th{background-color:#fef08a;text-align:center}.summary-warning-section{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:10px}.summary-box{border-collapse:collapse;width:45%}.summary-box td{border:1px solid #000;padding:4px}.warning-box{border:1px solid #dc2626;background-color:#fecaca;padding:6px;text-align:center;font-size:8px;width:40%}.warning-title{font-weight:bold;color:#b91c1c}.footer-section{display:flex;align-items:flex-end;justify-content:space-between;margin-top:10px}.footer-left{width:30%}.payment-info{margin-top:15px;font-size:9px}.payment-info p{margin:2px 0}@media print{body{-webkit-print-color-adjust:exact;color-adjust:exact}.logo-text{color:#dc2626!important}.items-table th{background-color:#fef08a!important}.warning-box{border-color:#dc2626!important;background-color:#fecaca!important}.warning-title{color:#b91c1c!important}.text-red-600{color:#dc2626!important}}
                </style></head><body><div class="nota-container"><div class="header"><div class="header-left"><div class="logo-text">MUSADAD.COM</div><div class="company-info">PERCETAKAN<br>Jl. Rp.Garendong - cisema Petir,<br>Kab.Serang BANTEN<br>Tlp. 083812352663<br>Email. musadad08@gmail.com</div></div><div class="header-right"><div class="info-row"><span class="info-label">Tanggal</span><span class="info-value">${new Date().toLocaleDateString('id-ID',{day:'2-digit',month:'2-digit',year:'numeric'})}</span></div><div class="info-row"><span class="info-label">Tuan</span><span class="info-value">${formData.customerName}</span></div><div class="info-row"><span class="info-label">Tlp.</span><span class="info-value">${formData.customerPhone}</span></div></div></div><div class="invoice-number-section"><strong>NO NOTA:</strong> ${formData.invoiceNumber}</div><table class="items-table"><thead><tr><th>BANYAK</th><th>NAMA BARANG</th><th>HARGA</th><th>JUMLAH</th></tr></thead><tbody>${formData.items.map(i=>`<tr><td style="text-align:center">${i.quantity}</td><td>${i.name}</td><td style="text-align:right">Rp ${i.price.toLocaleString('id-ID')}</td><td style="text-align:right">Rp ${(i.quantity*i.price).toLocaleString('id-ID')}</td></tr>`).join('')}</tbody></table><div class="summary-warning-section"><div class="warning-box"><div class="warning-title">PERHATIAN !!!</div><p>Barang-barang yang sudah dibeli tidak bisa ditukar / dikembalikan</p></div><table class="summary-box"><tr><td>Jumlah Rp.</td><td style="text-align:right">Rp ${formData.totalAmount.toLocaleString('id-ID')}</td></tr><tr><td>Uang Muka Rp.</td><td style="text-align:right">Rp ${formData.downPayment.toLocaleString('id-ID')}</td></tr><tr><td>Kurang Rp.</td><td style="text-align:right;font-weight:bold;" class="text-red-600">Rp ${(formData.totalAmount-formData.downPayment).toLocaleString('id-ID')}</td></tr></table></div><div class="footer-section"><div class="footer-left"><p>Diterima,</p><div style="height:32px;border-bottom:1px solid #000;margin-top:16px"></div><div style="margin-top:8px;text-align:center;font-weight:bold">( ................ )</div></div></div><div class="payment-info"><p><strong>PEMBAYARAN BISA MELALUI</strong></p><p>Transfer ke: NOREK BANK BCA</p><p><strong>5410927839 ROHMATULLOH AL MUSADAD</strong></p></div></div></body></html>`;
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        window.exportDatabase = async function() {
            try {
                const dataToExport = dbInstance.records;
                const jsonString = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `nota_backup_${new Date().toISOString()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                showCustomMessage('Data berhasil diunduh sebagai file JSON!');
            } catch (error) {
                console.error('Export error:', error);
                showCustomMessage('Gagal mengekspor data.');
            }
        }

        window.fetchData = function() {
            // This function now triggers the hidden file input
            document.getElementById('fileInput').click();
        }

        window.handleImportFile = function(event) {
            const file = event.target.files[0];
            if (!file) {
                showCustomMessage('Tidak ada file yang dipilih.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!Array.isArray(importedData)) {
                        throw new Error('Format file tidak valid. Harap unggah file JSON dengan array data.');
                    }
                    
                    const isConfirmed = await new Promise(resolve => showCustomMessageWithConfirmation('Ini akan menambahkan data baru ke database Anda. Apakah Anda yakin?', resolve, 'Ya, Tambahkan', 'Batal'));
                    
                    if (isConfirmed) {
                        const batch = writeBatch(db);
                        const collectionRef = collection(db, 'artifacts', appId, 'users', userId, 'invoices');
                        
                        importedData.forEach(item => {
                            const newDocRef = doc(collectionRef);
                            batch.set(newDocRef, {
                                ...item,
                                id: newDocRef.id, // Generate new ID
                                createdAt: new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            });
                        });
                        
                        await batch.commit();
                        showCustomMessage(`Berhasil menambahkan ${importedData.length} data nota baru!`);
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    showCustomMessage(`Gagal mengimpor file: ${error.message}`);
                }
                // Reset the input to allow importing the same file again if needed
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        window.searchInvoices = async function() {
            const queryText = document.getElementById('searchInput').value.trim();
            if (!queryText) {
                showCustomMessage('Mohon masukkan kata kunci pencarian.');
                return;
            }
            try {
                const results = await dbInstance.search(queryText);
                dbInstance.populateTable(results);
                showCustomMessage(`Ditemukan ${results.length} hasil pencarian.`);
            } catch (error) {
                showCustomMessage('Gagal melakukan pencarian.');
                console.error('Search error:', error);
            }
        }

        window.clearDatabase = async function() {
            const isConfirmed = await new Promise(r => showCustomMessageWithConfirmation('PERINGATAN: Ini akan menghapus SEMUA data. Yakin?', r, 'Ya, Hapus', 'Batal'));
            if (isConfirmed) {
                const isFinalConfirmed = await new Promise(r => showCustomMessageWithConfirmation('Konfirmasi sekali lagi: Semua data akan hilang permanen!', r, 'HAPUS SEMUA', 'Batalkan'));
                if (isFinalConfirmed) {
                    try {
                        // This operation is not standard in Firestore, so we'll simulate a mass delete
                        const q = query(collection(db, 'artifacts', appId, 'users', userId, 'invoices'));
                        const querySnapshot = await getDocs(q);
                        const batch = writeBatch(db);
                        querySnapshot.forEach((doc) => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        showCustomMessage('Database berhasil dikosongkan!');
                    } catch (error) {
                        showCustomMessage('Gagal mengosongkan database!');
                        console.error('Clear DB error:', error);
                    }
                }
            }
        }
        
        function showCustomMessage(message) {
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:2000;padding:1rem;';
            const box = document.createElement('div');
            box.style.cssText = 'background:white;padding:25px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);max-width:400px;text-align:center;';
            
            const msg = document.createElement('p');
            msg.textContent = message;
            msg.style.cssText = 'font-size:1rem;color:#333;margin-bottom:20px;line-height:1.5;';

            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Tutup';
            closeBtn.style.cssText = 'background:#6b7280;color:white;padding:10px 20px;border:none;border-radius:9999px;font-weight:600;cursor:pointer;';
            closeBtn.onclick = () => overlay.remove();

            box.append(msg, closeBtn);
            overlay.appendChild(box);
            document.body.appendChild(overlay);
        }
        
        function showCustomMessageWithConfirmation(message, callback, confirmText = 'OK', cancelText = 'Batal') {
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:2000;padding:1rem;';
            const box = document.createElement('div');
            box.style.cssText = 'background:white;padding:25px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);max-width:400px;text-align:center;';
            
            const msg = document.createElement('p');
            msg.textContent = message;
            msg.style.cssText = 'font-size:1rem;color:#333;margin-bottom:20px;line-height:1.5;';

            const btnContainer = document.createElement('div');
            btnContainer.style.cssText = 'display:flex;justify-content:center;gap:10px;';

            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = confirmText;
            confirmBtn.style.cssText = 'background:#43a047;color:white;padding:10px 20px;border:none;border-radius:9999px;font-weight:600;cursor:pointer;';
            confirmBtn.onclick = () => { overlay.remove(); callback(true); };

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = cancelText;
            cancelBtn.style.cssText = 'background:#6b7280;color:white;padding:10px 20px;border:none;border-radius:9999px;font-weight:600;cursor:pointer;';
            cancelBtn.onclick = () => { overlay.remove(); callback(false); };

            btnContainer.append(confirmBtn, cancelBtn);
            box.append(msg, btnContainer);
            overlay.appendChild(box);
            document.body.appendChild(overlay);
        }

        window.firstRecord = function() { dbInstance.first(); }
        window.prevRecord = function() { dbInstance.previous(); }
        window.nextRecord = function() { dbInstance.next(); }
        window.lastRecord = function() { dbInstance.last(); }
        
        document.getElementById('searchInput').addEventListener('keypress', e => { if (e.key === 'Enter') searchInvoices(); });

        window.openMaterialCalculator = function() {
            // Placeholder for calculator logic
            showCustomMessage('Fitur kalkulator bahan belum diimplementasikan sepenuhnya.');
        }
    </script>
</body>
</html>
